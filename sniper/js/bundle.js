!function(){"use strict";var e,t,i,a,s,n,o,r,h,l=Laya.View,c=Laya.Scene,d=Laya.ClassUtils.regClass;!function(e){class t extends l{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("BattleView")}}e.BattleViewUI=t,d("ui.BattleViewUI",t);class i extends l{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("FailView")}}e.FailViewUI=i,d("ui.FailViewUI",i);class a extends l{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("LoadingView")}}e.LoadingViewUI=a,d("ui.LoadingViewUI",a);class s extends l{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("VictoryView")}}e.VictoryViewUI=s,d("ui.VictoryViewUI",s)}(e||(e={})),function(e){!function(e){class t extends c{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/TestScene")}}e.TestSceneUI=t,d("ui.test.TestSceneUI",t)}(e.test||(e.test={}))}(e||(e={}));class m{constructor(){}static get instance(){return null==m._instance&&(m._instance=new m),m._instance}init(){this.event=new Laya.EventDispatcher}on(e,t,i){this.event.on(e,t,i)}off(e,t,i){this.event.off(e,t,i,!1)}fire(e,t){this.event.event(e,t)}fire2(e,t,i,a){let s=[];null!=t&&s.push(t),null!=i&&s.push(i),null!=a&&s.push(a),this.event.event(e,s)}}!function(e){e.updateGold="updateGold",e.addGold="addGold",e.subPackageLoadComplete="subPackageLoadComplete",e.signComplete="signComplete",e.newGuide_StartNextStep="newGuideStartNextStep",e.newGuide_CompleteStep="newGuideCompleteStep",e.newGuide_allComplete="newGuide_allComplete",e.startGame="startGame",e.reset_Game="reset_Game",e.stage_loadComplete="stage_loadComplete",e.stage_triggerFight="stage_triggerFight",e.stage_enemyDead="stage_enemyDead",e.gameOver="gameOver",e.hero_bloodUpdate="hero_bloodUpdate",e.ui_aimTouchDown="ui_aimTouchDown",e.ui_aimTouchUp="ui_aimTouchUp",e.ui_openAim="ui_openAim",e.ui_closeAim="ui_closeAim",e.ui_shoot="ui_shoot"}(t||(t={})),function(e){e[e.bullet=0]="bullet",e[e.hitEffect=1]="hitEffect"}(i||(i={})),function(e){e[e.thug=1]="thug",e[e.thug_suitcase=2]="thug_suitcase"}(a||(a={})),function(e){e[e.Win=0]="Win",e[e.shooted=1]="shooted",e[e.enemy_escape=2]="enemy_escape",e[e.hostage_shooted=3]="hostage_shooted"}(s||(s={}));class g{static getGuid(){return++g.GUID}static removeArr(e,t){var i=e.indexOf(t);return i>-1&&e.splice(i,1),e}static stringFormat(e,t){for(var i=0;i<t.length;i++){var a=new RegExp("\\{"+i+"\\}","gm");e=e.replace(a,t[i])}return e}static changeAngleTo360(e){return e>0?e>=360&&(e%=360):e<0&&(e<=-360&&(e%=360),e+=360),e}static splitStrToNum(e,t){var i=new Array,a=new Array;i=e.split(t);for(var s=0;s<i.length;s++)try{if(null==i[s])break;isNaN(i[s])?a[s]=i[s]:a[s]=JSON.parse(i[s])}catch(a){console.log("分割字符串错误："+e+"/// "+i[s]+"  flag = "+t)}return a}static findChildByName(e,t){let i=e.getChildByName(t);if(i)return i;for(let i=0;i<e.numChildren;i++){const a=e.getChildAt(i);if(a.numChildren>0){let e=g.findChildByName(a,t);if(null!=e)return e}}return null}static convert(e){if(e<1e3)return parseInt(e);let t=["K","M","G","B","T","aa","ab","ac","ad","ae","af","ag","ah","ai","aj","ak","al","am","an","ao","ap","aq","ar","as","at","au","av","aw","ax","ay","az","ba"],i=1e3,a=-1;for(;i<e;)a++,i*=1e3;return-1==a?e:a>=t.length?e:Math.floor(100*e*1e3/i)/100+t[a]}static random(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}static vibrate(){Laya.Browser.onMiniGame?wx.vibrateShort({success:null,fail:null,complete:null}):Laya.Browser.onQGMiniGame?qg.vibrateShort({success:null,fail:null,complete:null}):Laya.Browser.onVVMiniGame&&qg.vibrateShort({success:null,fail:null,complete:null})}static vibrateLong(){Laya.Browser.onMiniGame?wx.vibrateLong({success:null,fail:null,complete:null}):Laya.Browser.onQGMiniGame?qg.vibrateLong({success:null,fail:null,complete:null}):Laya.Browser.onVVMiniGame&&qg.vibrateLong({success:null,fail:null,complete:null})}static shareByPath(e,t){}static isShareSuccess(e){let t=(new Date).getTime();if(Laya.Browser.onMiniGame){let i=function(a){let s=!1;((new Date).getTime()-t)/1e3>=3&&(s=!0),wx.offShow(i),e&&e(s)};wx.onShow(i)}else e&&e(!0)}static wxShowNotice(e){if(Laya.Browser.onMiniGame){let t={title:"提示",content:"操作失败，请尝试不同群",showCancel:!0,confirmText:"去分享",confirmColor:"#5194b9",success:function(t){t.cancel?e&&e(!1):e&&e(!0)}};wx.showModal(t)}}static showSystemNotice(e){if(Laya.Browser.onMiniGame){let t={title:e,icon:"fail",duration:2e3};wx.showToast(t)}else if(Laya.Browser.onQGMiniGame){let t={title:e,icon:"success",duration:2e3};qg.showToast(t)}else if(Laya.Browser.onVVMiniGame){let t={message:e};qg.showToast(t)}}static oppoCreateTable(){}static setRankData(e){if(Laya.Browser.onMiniGame){var t=[],i={wxgame:{}};i.wxgame.value1=e,i.wxgame.update_time=Laya.Browser.now(),t.push({key:"goldRank",value:JSON.stringify(i)}),wx.setUserCloudStorage({KVDataList:t,success:function(e){},fail:function(e){console.log("-----fail:"+JSON.stringify(e))},complete:function(e){}})}}static aldEventByType(e){Laya.Browser.onMiniGame&&wx.aldSendEvent(e)}static aldEventByTypeParam(e,t,i){Laya.Browser.onMiniGame&&wx.aldSendEvent(e,{param:i})}}g.GUID=1,g.vectorUp=new Laya.Vector3(0,1,0),g.vectorZero=new Laya.Vector3(0,0,0),g.vectorOne=new Laya.Vector3(1,1,1),g.whileColor=new Laya.Vector4(1,1,1,1),g.greenColor=new Laya.Vector4(0,1,0,1),g.yellowColor=new Laya.Vector4(1,1,0,1),function(e){e.share_Offline="离线奖励分享",e.share_Upgrade="用户升级分享",e.share_double_gold="双倍金币分享",e.share_double_speed="双倍速度分享",e.share_manager_upgrade="升级管理员分享",e.share_fly="飞行物分享",e.share_lottery="抽奖分享",e.ald_stage_level="关卡等级",e.ald_horse_level="马等级",e.ald_arrow_level="箭等级",e.ald_earn_level="收益等级",e.ald_newGuide="新手引导完成",e.ald_start_load="开始加载",e.ald_load_complete="加载完成",e.ald_load_time="加载时长",e.ald_share="自愿分享"}(n||(n={}));class u{constructor(){this.enemyIdInfos=[],this.missions=[]}initData(e){this.id=JSON.parse(e.id),this.scene=e.scene,this.stage=e.stage,this.hitRate=JSON.parse(e.hitRate);let t=g.splitStrToNum(e.enemyIds,"_");for(let e=0;e<t.length;e++){const i=t[e];let a=new p;a.index=e+1,a.id=i,this.enemyIdInfos.push(a)}let i=g.splitStrToNum(e.missions,"|");for(let e=0;e<i.length;e++){const t=i[e];let a=g.splitStrToNum(t,"_");if(a){let e=new y;e.id=a[0],e.num=a[1],this.missions.push(e)}}}}class p{}class y{}class f{initData(e){this.id=JSON.parse(e.id),this.res=e.res,this.enemyType=JSON.parse(e.enemyType),this.missionType=JSON.parse(e.missionType),this.isStartExit=1==JSON.parse(e.isStartExit)}}!function(e){e[e.gun=1]="gun",e[e.knife=2]="knife",e[e.gun_knife=3]="gun_knife",e[e.banker=4]="banker",e[e.exit=5]="exit",e[e.giveup=6]="giveup"}(o||(o={}));class w{initData(e){this.id=JSON.parse(e.id),this.icon=e.icon,this.desc=e.desc,this.missionType=JSON.parse(e.missionType)}}!function(e){e.goldData="goldData",e.stageLevelData="stageLevelData",e.loginTime="loginTime"}(r||(r={}));class L{constructor(){this.stageConfigs=[],this.enemyConfigs=[],this.missionConfigs=[]}init(){this.mGold=0,this.offlineTime=0,this.mStageLevel=1}getCacheStorage(e){return localStorage.getItem(e)}setCacheStorage(e,t){try{localStorage.setItem(e,t)}catch(e){}}loadCache(){var e=this.getCacheStorage(r.goldData);null!=e&&""!=e&&(this.mGold=JSON.parse(e));var t=this.getCacheStorage(r.stageLevelData);null!=t&&""!=t&&(this.mStageLevel=JSON.parse(t));var i=this.getCacheStorage(r.loginTime),a=new Date;let s=a.getTime(),n=a.getDate(),o=a.getMonth();if(null!=i&&""!=i){let e=JSON.parse(i);this.offlineTime=(s-e.time)/1e3}let h={time:s,day:n,month:o,num:1};this.setCacheStorage(r.loginTime,JSON.stringify(h))}addGold(e){e=Math.floor(e),this.mGold+=e,this.setCacheStorage(r.goldData,this.mGold.toString()),m.instance.fire(t.updateGold,this.mGold),m.instance.fire(t.addGold,e)}subGold(e){e=Math.floor(e),this.mGold<e||(this.mGold-=e,this.setCacheStorage(r.goldData,this.mGold.toString()),m.instance.fire(t.updateGold,this.mGold))}nextStage(){this.mStageLevel++,console.log("下一关 ===== "+this.mStageLevel),this.setCacheStorage(r.stageLevelData,this.mStageLevel.toString())}getCurStageConfig(){if(this.stageConfigs.length<this.mStageLevel){let e=this.mStageLevel%10;0==e&&(e=10);let t=this.stageConfigs.length-10+e;return t>this.stageConfigs.length&&(t=this.stageConfigs.length),this.stageConfigs[t-1]}return this.stageConfigs[this.mStageLevel-1]}getEnemyConfig(e){return this.enemyConfigs[e-1]}getMissionConfigById(e){return this.missionConfigs[e-1]}resetGame(){}loadStageConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new u;a.initData(i),this.stageConfigs.push(a)}}loadEnemyConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new f;a.initData(i),this.enemyConfigs.push(a)}}loadMissionConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new w;a.initData(i),this.missionConfigs.push(a)}}}class v{init(){}openScene(e,t,i){null==i&&(i=!0);let a=[t];Laya.Scene.open(e,i,null,Laya.Handler.create(this,this.onOpenCompleteScene,a))}onOpenCompleteScene(e,t){e&&e.runWith(t)}loadScene(e,t){let i=[t];Laya.Scene.load(e,Laya.Handler.create(this,this.onCompleteScene,i))}onCompleteScene(e,t){e&&e.runWith(t)}loadScene3D(e,t){let i=[t];Laya.Scene3D.load(e,Laya.Handler.create(this,this.onCompleteScene3D,i))}onCompleteScene3D(e,t){this.scene3D=t;console.log("scene.reflectionIntensity = "+t.reflectionIntensity),Laya.stage.addChildAt(t,0),e&&e.runWith(t)}}class C{constructor(){}init(){}loadPrefab3D(e,t,i,a){Laya.Sprite3D.load(e,Laya.Handler.create(i,t,a))}loadTexture(e,t){Laya.Texture2D.load(e,t)}loadMaterial(e,t){Laya.BaseMaterial.load(e,t)}load(e,t){Laya.loader.load(e,Laya.Handler.create(this,t))}}class S{constructor(){}init(){}onceExecute(e,t,i,a){e*=1e3,Laya.timer.once(e,t,i,a)}clear(e,t){Laya.timer.clear(e,t)}clearAll(e){Laya.timer.clearAll(e)}loop(e,t,i,a){e*=1e3,Laya.timer.loop(e,t,i,a)}framLoop(e,t,i){Laya.timer.frameLoop(1,e,t,i)}frameOnce(e,t,i){Laya.timer.frameOnce(e,t,i)}}class M{}M.MainView="MainView.scene",M.BattleView="BattleView.scene",M.FailView="FailView.scene",M.VictoryView="VictoryView.scene",M.battleScenePath="unity/Conventional/Battle.ls",M.resRootPath="unity/Conventional/",M.startScene="LoadingView.scene",M.SCREEN_FIT_TOP=60,M.FLY_COIN_TIME=180,M.texPath="tex/",M.cardPoolSign="cardPoolSign",M.rotateCameraX1=-30.3,M.rotateCameraX2=-62.4,M.gid="5ef0b211b4f06b55fe0bf329",M.bid="5ef0b3fcb4f06b55fe0bf32c";class B{constructor(){this.adUnitId_BannerAd="adunit-930f894961022d82",this.adUnitId_RecommendAd="PBgAAfkSVjbG5zPQ",this.adUnitId_VideoAd="adunit-446ea7b2d94863ec"}init(){this.initBannerAd()}initBannerAd(){if(Laya.Browser.onMiniGame){let e=80,t=300,i=wx.getSystemInfoSync();this.bannerAd=wx.createBannerAd({adUnitId:this.adUnitId_BannerAd,adIntervals:30,style:{left:(i.windowWidth-t)/2,top:i.windowHeight-e,width:t}}),this.bannerAd.onResize(e=>{this.bannerAd.style.top=i.windowHeight-this.bannerAd.style.realHeight});this.bannerAd.onLoad(function(){console.log("showBannerAd  成功")}),this.bannerAd.onError(function(e){console.log("showBannerAd  失败"),console.log(e)})}}showGuessLike(){}initRecommendAd(){if(Laya.Browser.onMiniGame){this.mainViewIconAd=null;let e=wx.getSystemInfoSync(),t=270,i=75;wx.createGameIcon&&(this.mainViewIconAd=wx.createGameIcon({adUnitId:this.adUnitId_RecommendAd,count:1,style:[{left:e.windowWidth-i,top:e.windowHeight-t,appNameHidden:!0,color:"#ffffff"}]}))}}initInterstitialAd(){Laya.Browser.onMiniGame&&wx.createInterstitialAd&&(this.interstitialAd=wx.createInterstitialAd({adUnitId:"adunit-95a77896c0c93647"}),this.interstitialAd.onError(function(e){console.log(e)}))}initGridAd(){if(!Laya.Browser.onMiniGame||!wx.createGridAd)return;let e=wx.getSystemInfoSync();this.gridAd=wx.createGridAd({adUnitId:"adunit-287fad9efd2c05d8",adTheme:"white",gridCount:5,style:{left:(e.windowWidth-300)/2,top:e.windowHeight-80,width:300}}),this.gridAd.onResize(t=>{this.gridAd.style.top=e.windowHeight-this.gridAd.style.realHeight}),this.gridAd.onError(function(e){console.log(e)})}showRecommendAdIcon(){Laya.Browser.onMiniGame&&null!=this.mainViewIconAd&&this.mainViewIconAd&&this.mainViewIconAd.show()}hideRecommendAdIcon(){Laya.Browser.onMiniGame&&null!=this.mainViewIconAd&&this.mainViewIconAd&&this.mainViewIconAd.hide()}showInterstitialAd(){Laya.Browser.onMiniGame&&null!=this.interstitialAd&&this.interstitialAd.show().catch(e=>{console.log(e)})}showGridAd(){Laya.Browser.onMiniGame&&null!=this.gridAd&&this.gridAd.show()}hideGridAd(){Laya.Browser.onMiniGame&&null!=this.gridAd&&this.gridAd.hide()}showBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&this.bannerAd.show()}refreshBannerAd(){if(Laya.Browser.onMiniGame){let e=80,t=300,i=wx.getSystemInfoSync();this.bannerAd&&(this.bannerAd.offError(),this.bannerAd.destroy()),this.bannerAd=wx.createBannerAd({adUnitId:this.adUnitId_BannerAd,adIntervals:30,style:{left:(i.windowWidth-t)/2,top:i.windowHeight-e,width:t}}),this.bannerAd.onResize(e=>{this.bannerAd.style.top=i.windowHeight-this.bannerAd.style.realHeight});this.bannerAd.onLoad(function(){console.log("showBannerAd  成功")}),this.bannerAd.onError(function(e){console.log("showBannerAd  失败"),console.log(e)})}}refreshShowBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&(this.refreshBannerAd(),this.bannerAd.show())}hideBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&this.refreshBannerAd()}showAd(e,t){if(!Laya.Browser.onMiniGame)return void(e&&e(!0));console.log("开始广告");let i=this.adUnitId_VideoAd;this.RewardedVideoAd=wx.createRewardedVideoAd({adUnitId:i}),this.RewardedVideoAd.onError(function(t){console.log("加载广告失败"+JSON.stringify(t)),a.showToastFail("加载广告失败"),e&&e(!1)});let a=this;this.RewardedVideoAd.offClose(),this.RewardedVideoAd.onClose(function(t){console.log("关闭广告"),t&&t.isEnded||void 0===t?(console.log("视频回调成功"),e&&e(!0)):(console.log("关闭视频无奖励"),a.showToastFail("未看完,无奖励"),e&&e(!1))}),a.RewardedVideoAd.show().catch(function(e){a.RewardedVideoAd.load().then(function(){a.RewardedVideoAd.show()})})}showToastFail(e){let t={title:e,icon:"fail",duration:2e3};wx.showToast(t)}}class b{constructor(){console.log("game")}static get instance(){return null==b._instance&&(b._instance=new b),b._instance}init(){this.userData=new L,this.userData.init(),this.eventManager=m.instance,this.eventManager.init(),this.scenesManager=new v,this.scenesManager.init(),this.loadManager=new C,this.loadManager.init(),this.timeManager=new S,this.timeManager.init(),this.ad=new B,this.ad.init(),this.loadScene()}loadCacheData(e){}loadScene(){this.scenesManager.openScene(M.startScene,Laya.Handler.create(this,this.onCompleteScene),!0)}loadSubpackageAsyn(){let e=this;wx.loadSubpackage({name:"tex",success:function(i){e.isSubPackageLoadComplete=!0,e.eventManager.fire(t.subPackageLoadComplete)},fail:function(e){}})}onCompleteScene(e){this.log("onCompleteScene"),this.setSceneUI(e)}log(e){console.log(e)}setScene3D(e){this.scene3D=e;let t=e.getChildByName("CameraParent");this.camera=t.getChildByName("Main Camera")}setSceneUI(e){this.sceneUI=e}loadSound(){if(Laya.Browser.onMiniGame){wx.loadSubpackage({name:"sound",success:function(e){Laya.SoundManager.playMusic("sound/bgm.mp3",0)},fail:function(e){}})}}}class A{constructor(){this.targetAngle=0,this.tempAngle1=new Laya.Vector3(0,0,0),this.tempV=new Laya.Vector3,this.tempV2=new Laya.Vector3}init(){this.cameraParent=b.instance.scene3D.getChildByName("CameraParent"),this.camera=this.cameraParent.getChildByName("Main Camera"),this.gunRecoilStart=!1,b.instance.eventManager.on(t.ui_openAim,this,this.startAim),b.instance.eventManager.on(t.ui_closeAim,this,this.cancelAim),b.instance.eventManager.on(t.ui_shoot,this,this.shoot)}onLateUpdate(){this.doRecoil()}setCameraParentPos(e,t){this.cameraParent.transform.position=e,this.cameraParent.transform.rotationEuler=t}doRecoil(){this.gunRecoilStart&&(this.tempV.x=this.targetAngle,this.tempV.y=this.cameraParent.transform.localRotationEuler.y,this.tempV.z=0,Laya.Vector3.lerp(this.cameraParent.transform.localRotationEuler,this.tempV,15*Laya.timer.delta/1e3,this.tempV2),this.tempV2.z=0,this.cameraParent.transform.localRotationEuler=this.tempV2)}shoot(){this.gunRecoilStart=!0;let e=this.cameraParent.transform.localRotationEuler.x;this.targetAngle=e-2;let t=this;b.instance.timeManager.onceExecute(.2,this,function(){t.gunRecoilStart=!1,t.tempAngle1.x=t.cameraParent.transform.localRotationEuler.x,t.tempAngle1.y=t.cameraParent.transform.localRotationEuler.y,t.tempAngle1.z=0;Laya.Tween.to(t.tempAngle1,{x:e,update:new Laya.Handler(this,function(){t.tempAngle1.z=0,t.cameraParent.transform.localRotationEuler=t.tempAngle1})},300,null)})}startAim(){Laya.Tween.clearAll(this.camera),Laya.Tween.to(this.camera,{fieldOfView:17},300,null)}cancelAim(){Laya.Tween.clearAll(this.camera),Laya.Tween.to(this.camera,{fieldOfView:77},300,null)}moveAim(e,t){let i=this.cameraParent.transform.localRotationEuler.x+t,a=this.cameraParent.transform.localRotationEuler.y+e;this.tempV.x=i,this.tempV.y=a,this.tempV.z=0,Laya.Vector3.lerp(this.cameraParent.transform.localRotationEuler,this.tempV,1*Laya.timer.delta/1e3,this.tempV2),this.cameraParent.transform.localRotationEuler=this.tempV2}}class D extends Laya.Script3D{init(e){this.damageCallBack=e}damage(e){this.damageCallBack&&this.damageCallBack(e)}}class x extends Laya.Script3D{constructor(){super()}onDisable(){b.instance.timeManager.clearAll(this)}onDestroy(){b.instance.timeManager.clearAll(this),this.owner=null}init(e,t){this.recycleType=t,b.instance.timeManager.onceExecute(e,this,this.recycle)}recycle(){switch(this.recycleType){case i.bullet:V.instance.recycleBulletRes(this.owner);break;case i.hitEffect:V.instance.recycleHitEffectRes(this.owner)}}}class V{constructor(){V._instance=this}static get instance(){return V._instance}init(){this.hitEffect=b.instance.scene3D.getChildByName("hitEffect"),this.bullet=b.instance.scene3D.getChildByName("bullet"),this.hitEffect.active=!1,this.bullet.active=!1}addAutoRecycleScr(e,t,i){let a=e.getComponent(x);null==a&&(a=e.addComponent(x)),a.init(t,i)}getHitEffectRes(){let e=Laya.Pool.getItem("hitEffectPool");return null==e&&(e=Laya.Sprite3D.instantiate(this.hitEffect)),e.active=!0,e}recycleHitEffectRes(e){e&&(e.removeSelf(),Laya.Pool.recover("hitEffectPool",e))}getBulletRes(){let e=Laya.Pool.getItem("bulletPool");return null==e&&(e=Laya.Sprite3D.instantiate(this.bullet)),e}recycleBulletRes(e){e&&(e.transform.localScale=g.vectorOne,e.removeSelf(),Laya.Pool.recover("bulletPool",e))}}class R extends Laya.Script3D{constructor(){super(),this.moveSpeed=150,this.moveSpeedZ=30,this.isMove=!1}init(e,t,i,a){this.moveDir=new Laya.Vector3,this.tempDir=new Laya.Vector3,this.tempZ=new Laya.Vector3(0,0,1),this.moveDis=t,this.curMoveDis=0,this.isMove=!0,this.hitResult=i,this.damageNum=a,Laya.Vector3.normalize(e,this.moveDir);this.owner.getChildByName("Trail")}onUpdate(){this.isMove&&this.doMove()}doMove(){let e=Laya.timer.delta*this.moveSpeed/1e3;this.curMoveDis+=e,Laya.Vector3.scale(this.moveDir,e,this.tempDir),this.owner.transform.translate(this.tempDir,!1),this.curMoveDis>=this.moveDis&&(this.isMove=!1,this.shootComplete())}movez(){this.isMove&&(Laya.Vector3.scale(this.tempZ,Laya.timer.delta*this.moveSpeedZ/1e3,this.tempDir),this.owner.transform.translate(this.tempDir,!1))}shootComplete(){if(this.owner.active=!1,this.hitResult.succeeded&&this.hitResult.collider.owner){let e=V.instance.getHitEffectRes();this.hitResult.collider.owner.addChild(e),e.transform.position=this.owner.transform.position,e.transform.setWorldLossyScale(g.vectorOne),V.instance.addAutoRecycleScr(e,.5,i.hitEffect),e.active=!0;let t=1;"headHit"==this.hitResult.collider.owner.name&&(t=2);let a=this.hitResult.collider.owner.getComponent(D);a&&a.damage(this.damageNum*t)}}clearData(){this.owner&&V.instance.recycleBulletRes(this.owner),this.destroy(),this.owner=null}}class P{constructor(){this.blood=100,this.bloodBase=100,this.rayHitResult=new Laya.HitResult,this.aimRay=new Laya.Ray(new Laya.Vector3,new Laya.Vector3),this.tempDir=new Laya.Vector3,this.tempDir1=new Laya.Vector3,this.tempDir2=new Laya.Vector3,this.tempMousePos=new Laya.Vector2,this.tempPos=new Laya.Vector3}init(){this.heroObj=b.instance.scene3D.getChildByName("hero"),this.heroObj.active=!1,b.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),this.blood=this.bloodBase}resetGame(){this.blood=this.bloodBase}damage(e){this.blood<=0||(this.blood-=e,b.instance.eventManager.fire(t.hero_bloodUpdate),this.blood<=0&&j.instance.gameOver(s.shooted))}stageLoadComplete(){let e=j.instance.stageManager.stageRes.getChildByName("HeroSpots");this.heroObj.transform.position=e.transform.position,this.heroObj.active=!0,this.heroObj.transform.rotationEuler=e.transform.rotationEuler,j.instance.cameraLogic.setCameraParentPos(this.heroObj.transform.position,this.heroObj.transform.rotationEuler),this.resetGame()}getHeroPos(){return this.heroObj.transform.position}shoot(){let e=.5*Laya.stage.width,t=.5*Laya.stage.height;(Laya.Browser.onQGMiniGame||Laya.Browser.onQQMiniGame||Laya.Browser.onVVMiniGame)&&(e=.5*Laya.Browser.width,t=.5*Laya.Browser.height);let i=j.instance.cameraLogic.camera.transform.position,a=Laya.Sprite3D.instantiate(j.instance.bullet);b.instance.scene3D.addChild(a),a.transform.position=i,a.active=!0,this.tempMousePos.x=e,this.tempMousePos.y=t,j.instance.cameraLogic.camera.viewportPointToRay(this.tempMousePos,this.aimRay),b.instance.scene3D.physicsSimulation.rayCast(this.aimRay,this.rayHitResult,100);let s=100;this.rayHitResult.succeeded?(Laya.Vector3.subtract(this.rayHitResult.point,a.transform.position,this.tempDir),s=Laya.Vector3.scalarLength(this.tempDir)):(Laya.Vector3.scale(this.aimRay.direction,100,this.tempDir1),Laya.Vector3.subtract(i,a.transform.position,this.tempDir2),Laya.Vector3.add(this.tempDir1,this.tempDir2,this.tempDir));let n=this.tempDir;this.tempDir1.x=-n.x+a.transform.position.x,this.tempDir1.y=-n.y+a.transform.position.y,this.tempDir1.z=-n.z+a.transform.position.z,a.transform.lookAt(this.tempDir1,g.vectorUp,!1),a.addComponent(R).init(this.tempDir,s,this.rayHitResult,70)}getAttackHeroPos(e){let t=this.heroObj.transform.position,i=2,a=1.1,s=i,n=a;return e?(i=.2,a=.3,s=g.random(0,100*i)/100-i/2,n=g.random(0,100*a)/100+.5):(s=g.random(0,100*i)/100-i/2)<=.2&&s>=-.2?(n=.3+a,s=i):n=g.random(0,100*a)/100+.5,this.tempPos.x=t.x+s,this.tempPos.y=t.y+n,this.tempPos.z=t.z,this.tempPos}}class T{constructor(){this.isHadTriggerFight=!1}init(){this.curStageConfig=b.instance.userData.getCurStageConfig(),this.isHadTriggerFight=!1,this.loadScene(),b.instance.eventManager.on(t.reset_Game,this,this.resetGame)}resetGame(){this.curStageConfig=b.instance.userData.getCurStageConfig(),this.isHadTriggerFight=!1,this.stageRes.removeSelf(),this.stageRes.destroy(),this.stageRes=null,this.loadStage()}loadScene(){let e=this.getPrefabPath(this.curStageConfig.scene);b.instance.loadManager.loadPrefab3D(e,function(e){this.sceneRes=e,b.instance.scene3D.addChild(e),this.loadStage(),Laya.Resource.destroyUnusedResources()},this)}loadStage(){let e=this.getPrefabPath(this.curStageConfig.stage);console.log(e),b.instance.loadManager.loadPrefab3D(e,function(e){this.stageRes=e,b.instance.scene3D.addChild(e),Laya.Resource.destroyUnusedResources(),b.instance.eventManager.fire(t.stage_loadComplete),this.setTrigger()},this)}getPrefabPath(e){return M.resRootPath+e+".lh"}setTrigger(){this.isHadTriggerFight=!1;let e=this.stageRes.getChildByName("Triggers"),t=this,i=function(e){t.triggerFight()};for(let t=0;t<e.numChildren;t++){e.getChildAt(t).addComponent(D).init(i)}}triggerFight(){this.isHadTriggerFight||(this.isHadTriggerFight=!0,b.instance.eventManager.fire(t.stage_triggerFight))}checkIsShootDamage(){return g.random(1,100)<=this.curStageConfig.hitRate}}class I extends Laya.Script3D{constructor(){super(),this.moveSpeed=100,this.isMove=!1,this.isDamage=!1}init(e,t,i){this.moveDir=new Laya.Vector3,this.tempDir=new Laya.Vector3,this.tempZ=new Laya.Vector3(0,0,1),this.moveDis=t,this.curMoveDis=0,this.isMove=!0,this.isDamage=i,this.moveSpeed=100,Laya.Vector3.normalize(e,this.moveDir)}onDisable(){}onUpdate(){this.isMove&&this.doMove()}doMove(){let e=Laya.timer.delta*this.moveSpeed/1e3;this.curMoveDis+=e,Laya.Vector3.scale(this.moveDir,e,this.tempDir),this.owner.transform.translate(this.tempDir,!1),this.curMoveDis>=this.moveDis&&(this.isMove=!1,this.shootComplete())}shootComplete(){}clearData(){this.owner&&(this.owner.active=!1,V.instance.recycleBulletRes(this.owner)),this.isMove=!1,this.destroy(),this.owner=null}}class G extends I{constructor(){super()}init(e,t,i){super.init(e,t,i);let a=this.owner.getChildByName("Trail");a&&(a.active=!0)}shootComplete(){let e=V.instance.getHitEffectRes();j.instance.heroManager.getHeroPos();b.instance.scene3D.addChild(e),e.transform.position=this.owner.transform.position,V.instance.addAutoRecycleScr(e,.5,i.hitEffect),e.active=!0;let t=this.owner.getChildByName("mesh");t&&(t.active=!1);let a=this;b.instance.timeManager.onceExecute(.5,this,function(){t&&(t.active=!0),a.clearData()}),this.isDamage&&j.instance.heroManager.damage(23)}}class _{constructor(){this.blood=100,this.shootMovePath=[]}init(e,i){this.enemyCfg=e,this.spotsParent=i,this.isDead=!1,this.blood=100,this.shootMovePath=[],b.instance.eventManager.on(t.stage_triggerFight,this,this.triggerFight),this.loadEnemy()}clearData(){b.instance.timeManager.clearAll(this),b.instance.eventManager.off(t.stage_triggerFight,this,this.triggerFight),this.headRoleBoxScript&&this.headRoleBoxScript.destroy(),this.bodyRoleBoxScript&&this.bodyRoleBoxScript.destroy(),this.owner&&(this.owner.removeSelf(),this.owner.destroy()),this.spotsParent=null,this.owner=null,this.animCtrl=null,this.headObj=null,this.bodyObj=null,this.headRoleBoxScript=null,this.bodyRoleBoxScript=null}loadEnemy(){let e=this.getPrefabPath(this.enemyCfg.res);console.log(e),b.instance.loadManager.loadPrefab3D(e,function(e){e=Laya.Sprite3D.instantiate(e),b.instance.scene3D.addChild(e),this.loadComplete(e)},this)}getPrefabPath(e){return M.resRootPath+e+".lh"}loadComplete(e){this.owner=e;let t=this.spotsParent.getChildByName("enemySpots1");this.owner.transform.position=t.transform.position,this.owner.transform.rotationEuler=t.transform.rotationEuler,this.owner.active=!0,this.headObj=g.findChildByName(this.owner,"headHit"),this.bodyObj=this.owner.getChildByName("bodyHit");let i=this.owner.getChildByName("root");this.animCtrl=i.getComponent(Laya.Animator),this.setBoxScript(),this.setShootSpots(),this.showWeapon()}showWeapon(){switch(this.enemyCfg.enemyType){case o.gun:let e=g.findChildByName(this.owner,"GunRoot");e&&(e.active=!0);let t=g.findChildByName(this.owner,"KnifeLeft");t&&(t.active=!1);break;case o.knife:let i=g.findChildByName(this.owner,"GunRoot");i&&(i.active=!1);let a=g.findChildByName(this.owner,"KnifeLeft");a&&(a.active=!0)}}setShootSpots(){let e=this.spotsParent.getChildByName("shootSpots");if(e)for(let t=0;t<e.numChildren;t++){let i=e.getChildAt(t);this.shootMovePath.push(i.transform.position)}}setBoxScript(){let e=this,t=function(t){e.damage(t)};this.headObj&&(this.headRoleBoxScript=this.headObj.addComponent(D),this.headRoleBoxScript.init(t)),this.bodyObj&&(this.bodyRoleBoxScript=this.bodyObj.addComponent(D),this.bodyRoleBoxScript.init(t))}damage(e){j.instance.isGameOver||this.isDead||null==this.owner||(j.instance.stageManager.triggerFight(),this.blood-=e,this.blood<=0&&this.dead())}dead(){this.isDead=!0,this.animCtrl.crossFade("Dead",.1,0,0)}triggerFight(){}}class E extends _{constructor(){super(...arguments),this.isMoveComplete=!1,this.movePath=[],this.curMoveIndex=0,this.moveSpeed=1.5,this.runSpeed=1.5,this.walkSpeed=.5,this.moveTempV=new Laya.Vector3,this.moveTempAngle=new Laya.Vector3}init(e,t){super.init(e,t),this.movePath=[],this.isStartMove=!1,this.isMoveComplete=!1}triggerFight(){if(!this.isDead){for(let e=0;e<this.shootMovePath.length;e++){const t=this.shootMovePath[e];this.movePath.push(t)}this.curMoveIndex=0,this.changeToRun()}}changeToRun(){this.isStartMove=!0,this.animCtrl.play("Run"),this.moveSpeed=this.runSpeed,Laya.Tween.clearAll(this.moveTempV),this.move()}move(){if(!this.isStartMove||this.movePath.length<=this.curMoveIndex)return;let e=this.movePath[this.curMoveIndex],t=this.owner.transform.position,i=1e3*Laya.Vector3.distance(e,t)/this.moveSpeed;this.moveTempV=t;Laya.Tween.to(this.moveTempV,{x:e.x,y:e.y,z:e.z,update:new Laya.Handler(this,function(){this.owner.transform.position=this.moveTempV})},i,null,Laya.Handler.create(this,function(){this.curMoveIndex++,this.movePath.length<=this.curMoveIndex?this.moveComplete():this.move()})),this.doRotateToPos(e)}doRotateToPos(e){let t=this.owner.transform.position,i=90-Laya.MathUtil.getRotation(t.x,t.z,e.x,e.z);this.moveTempAngle=this.owner.transform.localRotationEuler;let a=this.owner.transform.localRotationEuler.y,s=i-a;Math.abs(s)>=180&&(s=g.changeAngleTo360(s))>=180&&(s-=360),i=s+a;Laya.Tween.to(this.moveTempAngle,{y:i,update:new Laya.Handler(this,function(){this.owner.transform.localRotationEuler=this.moveTempAngle})},300,null)}moveComplete(){this.isMoveComplete=!0,this.isStartMove=!1}dead(){Laya.Tween.clearAll(this.moveTempAngle),Laya.Tween.clearAll(this.moveTempV),b.instance.timeManager.clearAll(this),super.dead(),b.instance.eventManager.fire(t.stage_enemyDead,this)}clearData(){Laya.Tween.clearAll(this.moveTempAngle),Laya.Tween.clearAll(this.moveTempV),super.clearData()}}class O extends E{constructor(){super(...arguments),this.isStartShoot=!1,this.shootInterval=1e3,this.curShootTime=0,this.tempDir=new Laya.Vector3,this.tempDir1=new Laya.Vector3}init(e,t){super.init(e,t),this.isStartShoot=!1,b.instance.timeManager.framLoop(this,this.update),this.shootInterval=g.random(3e3,5e3)}loadComplete(e){super.loadComplete(e),this.gunRoot=g.findChildByName(this.owner,"GunRoot")}update(){this.isDead||this.checkShoot()}changeToShoot(){this.isStartShoot=!0,this.animCtrl.play("Shoot"),this.doRotateToPos(j.instance.heroManager.getHeroPos())}moveComplete(){super.moveComplete(),this.changeToShoot()}triggerFight(){this.isDead||(this.shootMovePath.length<=0?this.changeToShoot():super.triggerFight())}checkShoot(){this.isStartShoot&&(this.curShootTime+=Laya.timer.delta,this.curShootTime>=this.shootInterval&&(this.curShootTime=0,this.doShoot()))}doShoot(){if(this.isDead)return;let e=V.instance.getBulletRes();b.instance.scene3D.addChild(e),e.transform.position=this.gunRoot.transform.position,e.active=!0;let t=j.instance.stageManager.checkIsShootDamage();this.tempDir1=j.instance.heroManager.getAttackHeroPos(t),Laya.Vector3.subtract(this.tempDir1,e.transform.position,this.tempDir);let i=Laya.Vector3.scalarLength(this.tempDir),a=this.tempDir;this.tempDir1.x=-a.x+e.transform.position.x,this.tempDir1.y=-a.y+e.transform.position.y,this.tempDir1.z=-a.z+e.transform.position.z,e.transform.lookAt(this.tempDir1,g.vectorUp,!1),e.addComponent(G).init(this.tempDir,i,t)}}class U extends E{init(e,t){super.init(e,t),this.blood=1}loadComplete(e){super.loadComplete(e),this.enemyCfg.enemyType==o.giveup&&this.animCtrl.play("GiveUp")}triggerFight(){this.shootMovePath.length<=0||super.triggerFight()}moveComplete(){super.moveComplete(),this.animCtrl.play("Idle"),this.doRotateToPos(j.instance.heroManager.getHeroPos())}}class k extends E{init(e,i){super.init(e,i),b.instance.eventManager.on(t.startGame,this,this.startGame)}startGame(){this.enemyCfg.isStartExit&&this.startEscape()}startEscape(){if(!(this.isDead||this.shootMovePath.length<=0)){for(let e=0;e<this.shootMovePath.length;e++){const t=this.shootMovePath[e];this.movePath.push(t)}this.curMoveIndex=0,this.isStartMove=!0,this.animCtrl.play("Walk"),this.moveSpeed=this.walkSpeed,this.move()}}triggerFight(){this.shootMovePath.length<=0||(this.isStartMove?this.changeToRun():super.triggerFight())}moveComplete(){super.moveComplete(),this.animCtrl.play("Idle"),b.instance.timeManager.onceExecute(.6,this,function(){console.log("任务失败，目标逃跑了"),j.instance.gameOver(s.enemy_escape)})}clearData(){b.instance.eventManager.off(t.startGame,this,this.startGame),super.clearData()}}class N{constructor(){this.enemys=[],this.hostages=[]}init(){b.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),b.instance.eventManager.on(t.stage_enemyDead,this,this.deadEnemy),b.instance.eventManager.on(t.reset_Game,this,this.resetGame)}stageLoadComplete(){this.curStageConfig=b.instance.userData.getCurStageConfig();let e=this.curStageConfig.enemyIdInfos;for(let t=0;t<e.length;t++){const i=e[t];this.loadEnemy(i)}}loadEnemy(e){let t=j.instance.stageManager.stageRes,i="enemy"+e.index,a=t.getChildByName(i);if(!a)return void console.log("表里面的敌人数量 和  预制里面敌人数量不一致   index === "+e.index);let s=b.instance.userData.getEnemyConfig(e.id),n=null;switch(s.enemyType){case o.gun:case o.gun_knife:(n=new O).init(s,a),this.enemys.push(n);break;case o.knife:(n=new k).init(s,a),this.enemys.push(n);break;case o.banker:(n=new U).init(s,a),this.hostages.push(n);break;case o.exit:(n=new k).init(s,a),this.enemys.push(n);break;case o.giveup:(n=new U).init(s,a),this.hostages.push(n)}}deadEnemy(e){e.enemyCfg.enemyType==o.banker&&(console.log("失败了   人质被打了"),j.instance.gameOver(s.hostage_shooted))}resetGame(){for(let e=0;e<this.enemys.length;e++){this.enemys[e].clearData()}this.enemys=[];for(let e=0;e<this.hostages.length;e++){this.hostages[e].clearData()}this.hostages=[]}}class H{init(e,t){this.missionCfg=e,this.missionState=h.start,this.progressNum=0,this.missionNum=t}updateProgress(){this.missionState!=h.complete&&(this.progressNum++,this.progressNum>=this.missionNum&&this.completeMission())}completeMission(){this.missionState=h.complete}}!function(e){e[e.start=1]="start",e[e.complete=2]="complete"}(h||(h={}));class F{constructor(){this.allMissionInfos=[]}init(){this.createMission(),b.instance.eventManager.on(t.stage_enemyDead,this,this.deadEnemy),b.instance.eventManager.on(t.reset_Game,this,this.resetGame)}resetGame(){this.allMissionInfos=[],this.createMission()}createMission(){let e=b.instance.userData.getCurStageConfig().missions;for(let t=0;t<e.length;t++){const i=e[t];let a=b.instance.userData.getMissionConfigById(i.id),s=new H;s.init(a,i.num),this.allMissionInfos.push(s)}}deadEnemy(e){for(let t=0;t<this.allMissionInfos.length;t++){const i=this.allMissionInfos[t];e.enemyCfg.missionType==i.missionCfg.missionType&&i.updateProgress()}this.checkMission()}checkMission(){for(let e=0;e<this.allMissionInfos.length;e++){if(this.allMissionInfos[e].missionState!==h.complete)return}console.log("所有任务完成  游戏 胜利"),j.instance.gameOver(s.Win)}}class j extends Laya.Script3D{constructor(){super(),this.isGameOver=!1,j._instance=this,this.init()}static get instance(){return j._instance}onAwake(){}onLateUpdate(){this.cameraLogic&&this.cameraLogic.onLateUpdate()}init(){this.bullet=b.instance.scene3D.getChildByName("bullet"),this.cameraLogic=new A,this.cameraLogic.init(),this.heroManager=new P,this.heroManager.init(),this.enemyManager=new N,this.enemyManager.init(),this.stageManager=new T,this.stageManager.init(),this.missionManager=new F,this.missionManager.init(),this.poolManager=new V,this.poolManager.init(),b.instance.eventManager.on(t.startGame,this,this.startGame)}gameOver(e){this.isGameOver||(this.isGameOver=!0,b.instance.eventManager.fire(t.gameOver,e))}startGame(){this.isGameOver=!1}}class z extends e.BattleViewUI{constructor(){super(),this.aimBtnPos=new Laya.Vector2,this.isCanFire=!1,this.totalBulletCount=4,this.curBulletCount=4,this.isReloadingBullet=!1,this.totalReloadTime=2e3,this.curReloadTime=0,this.isMoveAimDown=!1,this.delayCloseAim=null,this.doCloseAnimCallback=null,this.isStartGame=!1,this.doShowAimBtn=null,this.touchPos=new Laya.Vector2,this.startTouchPos=new Laya.Vector2,this.point=new Laya.Point}onAwake(){}onEnable(){this.init()}onDisable(){b.instance.eventManager.off(t.gameOver,this,this.gameOver)}init(){this.initObj(),this.initMask(),this.aimBox.alpha=0,this.moveAimBg.visible=!1,this.isMoveAimDown=!1,this.aimBtnPos.x=this.aimBtn.x,this.aimBtnPos.y=this.aimBtn.y,this.isCanFire=!1,this.totalBulletCount=4,this.curBulletCount=this.totalBulletCount,this.isReloadingBullet=!1,this.reloadSprite=new Laya.Sprite,this.reloadBox.addChild(this.reloadSprite),this.isStartGame=!1,this.battleInfoBox.visible=!1,b.instance.timeManager.framLoop(this,this.reloadBullet),this.reloadComplete(),this.hideCancelAimBtn(),this.showMissionList();let e=this;this.delayCloseAim=function(){e.closeAim()},this.doCloseAnimCallback=function(){e.aimBox.alpha=0,e.smallAimBox.visible=!0},this.doShowAimBtn=function(){e.aimBtn.alpha=.7},b.instance.eventManager.on(t.gameOver,this,this.gameOver),b.instance.eventManager.on(t.hero_bloodUpdate,this,this.showBloodInfo)}initObj(){this.aimBtn.on(Laya.Event.MOUSE_DOWN,this,this.onAimBtnDown),this.aimBtn.on(Laya.Event.MOUSE_UP,this,this.onAimBtnUp),this.aimBtn.on(Laya.Event.MOUSE_MOVE,this,this.onAimBtnMove),this.aimBox.on(Laya.Event.MOUSE_DOWN,this,this.onBgBtnDown),this.aimBox.on(Laya.Event.MOUSE_MOVE,this,this.onBgBtnMove),this.aimBox.on(Laya.Event.MOUSE_UP,this,this.onBgBtnUp),this.cancleAimBtn.on(Laya.Event.CLICK,this,this.onCancelBtnClick)}initMask(){var e=new Laya.Sprite;e.alpha=.5,e.graphics.drawRect(0,0,Laya.stage.width,Laya.stage.height,"#000000"),this.maskContain.addChild(e);let t=new Laya.Sprite;t.blendMode="destination-out",this.maskContain.addChild(t);let i=this.maskBox.x,a=this.maskBox.y;t.graphics.drawCircle(i,a,285,"#000000")}startGame(){this.isStartGame=!0,this.missionBox.visible=!1,this.battleInfoBox.visible=!0,this.showBloodInfo(),this.showBattleMissionList(),b.instance.eventManager.fire(t.startGame)}showBloodInfo(){let e=j.instance.heroManager.blood/j.instance.heroManager.bloodBase;this.bloodBar.value=e}showBattleMissionList(){var e=[];let t=j.instance.missionManager.allMissionInfos;for(let i=0;i<t.length;i++){const a=t[i];e.push({icon:{skin:"UI/"+a.missionCfg.icon+".png"}})}this.missionIconList.array=e,this.missionIconList.repeatY=t.length}showMissionList(){this.missionTitle.text="任 务 "+b.instance.userData.mStageLevel;var e=[];let t=b.instance.userData.getCurStageConfig().missions;for(let i=0;i<t.length;i++){const a=t[i];let s=b.instance.userData.getMissionConfigById(a.id),n=!0;1==a.num&&(n=!1),e.push({icon:{skin:"UI/"+s.icon+".png"},desc:{text:s.desc},countBg:{visible:n},countLabel:{visible:n,text:"x"+a.num}})}this.missionList.repeatY=t.length,this.missionList.array=e;let i=256+138*(t.length-1);this.missionBg.height=i}gameOver(e){e==s.Win?b.instance.timeManager.onceExecute(1.5,this,function(){b.instance.scenesManager.openScene(M.VictoryView,Laya.Handler.create(this,function(e){}))}):b.instance.scenesManager.openScene(M.FailView,Laya.Handler.create(this,function(t){t.init(e)}))}showBulletInfo(){var e=[];for(let t=0;t<this.totalBulletCount;t++)t>=this.curBulletCount?e.push({bulletIcon:{alpha:.3}}):e.push({bulletIcon:{alpha:1}});this.bulletList.array=e}startReload(){this.isReloadingBullet=!0,this.curReloadTime=0,this.reloadSprite.graphics.clear(),this.reloadBox.visible=!0}reloadComplete(){this.isReloadingBullet=!1,this.curBulletCount=this.totalBulletCount,this.showBulletInfo(),this.reloadBox.visible=!1}reloadBullet(){if(!this.isReloadingBullet)return;this.curReloadTime+=Laya.timer.delta;let e=this.curReloadTime/this.totalReloadTime,t=360*(e=Math.min(1,e));this.reloadSprite.graphics.clear(),this.reloadSprite.graphics.drawPie(this.reloadPos.x,this.reloadPos.y,40,-90,-90+t,"#ffffff"),this.curReloadTime>=this.totalReloadTime&&this.reloadComplete()}showCancelAimBtn(){Laya.Tween.to(this.cancleAimBtn,{x:0},300,null,Laya.Handler.create(this,function(){}))}hideCancelAimBtn(){this.cancleAimBtn.x=-150}closeAim(){b.instance.timeManager.onceExecute(.3,this,this.doCloseAnimCallback),this.hideCancelAimBtn(),b.instance.eventManager.fire(t.ui_closeAim)}openAnim(){b.instance.timeManager.clear(this,this.doCloseAnimCallback),b.instance.timeManager.clear(this,this.doShowAimBtn),this.smallAimBox.visible=!1,this.aimBtn.alpha=0;let e=300*(1-this.aimBox.alpha);Laya.Tween.to(this.aimBox,{alpha:1},e,null,Laya.Handler.create(this,function(){this.isCanFire=!0})),b.instance.eventManager.fire(t.ui_openAim)}onCancelBtnClick(){this.moveAimBg.visible=!0,this.aimBtn.alpha=0,this.isCanFire=!1,this.closeAim()}onBgBtnDown(e){0==this.isStartGame&&this.startGame(),this.moveAimBg.visible=!0,this.aimBtn.visible=!1,this.touchPos.x=e.stageX,this.touchPos.y=e.stageY}onBgBtnMove(e){this.doAimMove(e)}onBgBtnUp(e){this.moveAimBg.visible=!1,this.aimBtn.visible=!0}onAimBtnDown(e){0==this.isStartGame&&this.startGame(),this.isMoveAimDown=!1,this.isReloadingBullet?this.onBgBtnDown(e):(this.isMoveAimDown=!0,b.instance.timeManager.clear(this,this.delayCloseAim),this.isCanFire=!1,this.openAnim(),this.showCancelAimBtn(),this.touchPos.x=e.stageX,this.touchPos.y=e.stageY,b.instance.eventManager.fire(t.ui_aimTouchDown))}onAimBtnUp(e){this.aimBtn.x=this.aimBtnPos.x,this.aimBtn.y=this.aimBtnPos.y,this.moveAimBg.visible=!1,this.isMoveAimDown?(this.isMoveAimDown=!1,this.curBulletCount>0&&this.isCanFire?(j.instance.heroManager.shoot(),b.instance.eventManager.fire(t.ui_shoot),this.curBulletCount--,this.showBulletInfo(),this.curBulletCount<=0&&this.startReload(),b.instance.timeManager.onceExecute(.7,this,this.delayCloseAim),b.instance.timeManager.onceExecute(1,this,this.doShowAimBtn)):(b.instance.timeManager.onceExecute(.3,this,this.doShowAimBtn),this.closeAim()),b.instance.eventManager.fire(t.ui_aimTouchUp),this.isCanFire=!1):this.onBgBtnUp(e)}onAimBtnMove(e){this.doAimMove(e),this.point.x=e.stageX,this.point.y=e.stageY,this.point=this.aimBtn.parent.globalToLocal(this.point),this.aimBtn.x=this.point.x,this.aimBtn.y=this.point.y}doAimMove(e){let t=2*(e.stageX-this.touchPos.x),i=2*(e.stageY-this.touchPos.y);b.instance.timeManager.frameOnce(1,this,function(){j.instance.cameraLogic.moveAim(-t,i)}),this.touchPos.x=e.stageX,this.touchPos.y=e.stageY}}class J extends e.FailViewUI{constructor(){super()}onAwake(){}init(e){this.initObj();let t="";switch(e){case s.enemy_escape:t="敌人逃跑了";break;case s.hostage_shooted:t="人质被射杀了";break;case s.shooted:t="你没血了"}this.failDesc.text=t,console.log("游戏失败了  ====== "+t)}initObj(){this.restartBtn.on(Laya.Event.CLICK,this,this.onRestartBtnClick)}showInfo(){}onRestartBtnClick(){b.instance.eventManager.fire(t.reset_Game),b.instance.scenesManager.openScene(M.BattleView,Laya.Handler.create(this,function(e){b.instance.setSceneUI(e)}))}}class W extends e.LoadingViewUI{constructor(){super(),this.allLoadCount=0,this.curLoadCount=0,this.isLoading=!1}onAwake(){this.init()}onEnable(){}init(){b.instance.timeManager.framLoop(this,this.updateProgress),b.instance.userData.loadCache(),this.loadConfig(),this.loadRes(),this.isLoading=!0}updateProgress(){if(!this.isLoading)return;let e=0;this.allLoadCount>0&&(e=this.curLoadCount/this.allLoadCount),this.allLoadCount<=this.curLoadCount&&(this.isLoading=!1,this.allLoadComplete())}allLoadComplete(){this.startLoadScene3D()}loadRes(){Laya.Browser.onMiniGame&&this.startLoadSubpackage()}startLoadSubpackage(){this.doLoadSubpackage("unity")}doLoadSubpackage(e){this.allLoadCount+=30;let t=this;wx.loadSubpackage({name:e,success:function(e){t.curLoadCount+=30},fail:function(e){}}).onProgressUpdate(function(e){})}startLoadScene3D(){b.instance.scenesManager.loadScene3D(M.battleScenePath,Laya.Handler.create(this,this.loadScene3DComplete))}loadScene3DComplete(e){b.instance.setScene3D(e),b.instance.scene3D.addComponent(j),b.instance.scenesManager.openScene(M.BattleView,Laya.Handler.create(this,function(e){b.instance.setSceneUI(e)}))}loadConfig(){this.load("config/StageConfig.json",function(e){b.instance.userData.loadStageConfig(e)}),this.load("config/EnemyConfig.json",function(e){b.instance.userData.loadEnemyConfig(e)}),this.load("config/MissionConfig.json",function(e){b.instance.userData.loadMissionConfig(e)})}load(e,t){this.allLoadCount++;let i=this;b.instance.loadManager.load(e,function(e){t(e),i.curLoadCount++})}}class Q extends e.test.TestSceneUI{constructor(){super();var e=Laya.stage.addChild(new Laya.Scene3D),t=e.addChild(new Laya.Camera(0,.1,100));t.transform.translate(new Laya.Vector3(0,3,3)),t.transform.rotate(new Laya.Vector3(-30,0,0),!0,!1);var i=e.addChild(new Laya.DirectionLight);i.color=new Laya.Vector3(.6,.6,.6),i.transform.worldMatrix.setForward(new Laya.Vector3(1,-1,0));var a=e.addChild(new Laya.MeshSprite3D(Laya.PrimitiveMesh.createBox(1,1,1)));a.transform.rotate(new Laya.Vector3(0,45,0),!1,!1);var s=new Laya.BlinnPhongMaterial;Laya.Texture2D.load("res/layabox.png",Laya.Handler.create(null,function(e){s.albedoTexture=e})),a.meshRenderer.material=s}}class Y extends e.VictoryViewUI{constructor(){super()}onAwake(){this.init()}init(){this.initObj(),this.showInfo()}initObj(){this.nextBtn.on(Laya.Event.CLICK,this,this.onNextBtnClick)}showInfo(){let e=b.instance.userData.mStageLevel;this.title.text="任 务 "+e,b.instance.userData.nextStage()}onNextBtnClick(){b.instance.eventManager.fire(t.reset_Game),b.instance.scenesManager.openScene(M.BattleView,Laya.Handler.create(this,function(e){b.instance.setSceneUI(e)}))}}class q{constructor(){}static init(){var e=Laya.ClassUtils.regClass;e("View/BattleView.ts",z),e("View/FailView.ts",J),e("View/LoadingView.ts",W),e("script/GameUI.ts",Q),e("View/VictoryView.ts",Y)}}q.width=720,q.height=1280,q.scaleMode="fixedwidth",q.screenMode="none",q.alignV="top",q.alignH="left",q.startScene="LoadingView.scene",q.sceneRoot="",q.debug=!1,q.stat=!1,q.physicsDebug=!1,q.exportSceneToJson=!0,q.init();new class{constructor(){window.Laya3D?Laya3D.init(q.width,q.height):Laya.init(q.width,q.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=q.scaleMode,Laya.stage.screenMode=q.screenMode,Laya.stage.alignV=q.alignV,Laya.stage.alignH=q.alignH,Laya.URL.exportSceneToJson=q.exportSceneToJson,(q.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),q.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),q.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){b.instance.init()}}}();