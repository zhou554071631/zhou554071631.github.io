!function(){"use strict";var e,t,i,a,s,o,n,r,l,h,c,d=Laya.View,m=Laya.Scene,g=Laya.ClassUtils.regClass;!function(e){class t extends d{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("BattleView")}}e.BattleViewUI=t,g("ui.BattleViewUI",t);class i extends d{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("FailView")}}e.FailViewUI=i,g("ui.FailViewUI",i);class a extends d{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("LoadingView")}}e.LoadingViewUI=a,g("ui.LoadingViewUI",a);class s extends d{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("VictoryView")}}e.VictoryViewUI=s,g("ui.VictoryViewUI",s)}(e||(e={})),function(e){!function(e){class t extends m{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/TestScene")}}e.TestSceneUI=t,g("ui.test.TestSceneUI",t)}(e.test||(e.test={}))}(e||(e={}));class u{constructor(){}static get instance(){return null==u._instance&&(u._instance=new u),u._instance}init(){this.event=new Laya.EventDispatcher}on(e,t,i){this.event.on(e,t,i)}off(e,t,i){this.event.off(e,t,i,!1)}fire(e,t){this.event.event(e,t)}fire2(e,t,i,a){let s=[];null!=t&&s.push(t),null!=i&&s.push(i),null!=a&&s.push(a),this.event.event(e,s)}}!function(e){e.updateGold="updateGold",e.addGold="addGold",e.subPackageLoadComplete="subPackageLoadComplete",e.signComplete="signComplete",e.newGuide_StartNextStep="newGuideStartNextStep",e.newGuide_CompleteStep="newGuideCompleteStep",e.newGuide_allComplete="newGuide_allComplete",e.startGame="startGame",e.reset_Game="reset_Game",e.stage_loadComplete="stage_loadComplete",e.stage_triggerFight="stage_triggerFight",e.stage_enemyDead="stage_enemyDead",e.gameOver="gameOver",e.missionStateComplete="missionStateComplete",e.missionUpdateProgress="missionUpdateProgress",e.hero_bloodUpdate="hero_bloodUpdate",e.ui_aimTouchDown="ui_aimTouchDown",e.ui_aimTouchUp="ui_aimTouchUp",e.ui_openAim="ui_openAim",e.ui_closeAim="ui_closeAim",e.ui_shoot="ui_shoot"}(t||(t={})),function(e){e[e.bullet=0]="bullet",e[e.hitEffect=1]="hitEffect",e[e.bombEffect=2]="bombEffect"}(i||(i={})),function(e){e[e.thug=1]="thug",e[e.thug_suitcase=2]="thug_suitcase"}(a||(a={})),function(e){e[e.Win=0]="Win",e[e.shooted=1]="shooted",e[e.enemy_escape=2]="enemy_escape",e[e.hostage_shooted=3]="hostage_shooted"}(s||(s={})),function(e){e[e.none=0]="none",e[e.left=1]="left",e[e.right=2]="right"}(o||(o={}));class p{static getGuid(){return++p.GUID}static removeArr(e,t){var i=e.indexOf(t);return i>-1&&e.splice(i,1),e}static stringFormat(e,t){for(var i=0;i<t.length;i++){var a=new RegExp("\\{"+i+"\\}","gm");e=e.replace(a,t[i])}return e}static changeAngleTo360(e){return e>0?e>=360&&(e%=360):e<0&&(e<=-360&&(e%=360),e+=360),e}static splitStrToNum(e,t){var i=new Array,a=new Array;i=e.split(t);for(var s=0;s<i.length;s++)try{if(null==i[s])break;isNaN(i[s])?a[s]=i[s]:a[s]=JSON.parse(i[s])}catch(a){console.log("分割字符串错误："+e+"/// "+i[s]+"  flag = "+t)}return a}static findChildByName(e,t){let i=e.getChildByName(t);if(i)return i;for(let i=0;i<e.numChildren;i++){const a=e.getChildAt(i);if(a.numChildren>0){let e=p.findChildByName(a,t);if(null!=e)return e}}return null}static convert(e){if(e<1e3)return parseInt(e);let t=["K","M","G","B","T","aa","ab","ac","ad","ae","af","ag","ah","ai","aj","ak","al","am","an","ao","ap","aq","ar","as","at","au","av","aw","ax","ay","az","ba"],i=1e3,a=-1;for(;i<e;)a++,i*=1e3;return-1==a?e:a>=t.length?e:Math.floor(100*e*1e3/i)/100+t[a]}static random(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}static vibrate(){Laya.Browser.onMiniGame?wx.vibrateShort({success:null,fail:null,complete:null}):Laya.Browser.onQGMiniGame?qg.vibrateShort({success:null,fail:null,complete:null}):Laya.Browser.onVVMiniGame&&qg.vibrateShort({success:null,fail:null,complete:null})}static vibrateLong(){Laya.Browser.onMiniGame?wx.vibrateLong({success:null,fail:null,complete:null}):Laya.Browser.onQGMiniGame?qg.vibrateLong({success:null,fail:null,complete:null}):Laya.Browser.onVVMiniGame&&qg.vibrateLong({success:null,fail:null,complete:null})}static shareByPath(e,t){}static isShareSuccess(e){let t=(new Date).getTime();if(Laya.Browser.onMiniGame){let i=function(a){let s=!1;((new Date).getTime()-t)/1e3>=3&&(s=!0),wx.offShow(i),e&&e(s)};wx.onShow(i)}else e&&e(!0)}static wxShowNotice(e){if(Laya.Browser.onMiniGame){let t={title:"提示",content:"操作失败，请尝试不同群",showCancel:!0,confirmText:"去分享",confirmColor:"#5194b9",success:function(t){t.cancel?e&&e(!1):e&&e(!0)}};wx.showModal(t)}}static showSystemNotice(e){if(Laya.Browser.onMiniGame){let t={title:e,icon:"fail",duration:2e3};wx.showToast(t)}else if(Laya.Browser.onQGMiniGame){let t={title:e,icon:"success",duration:2e3};qg.showToast(t)}else if(Laya.Browser.onVVMiniGame){let t={message:e};qg.showToast(t)}}static oppoCreateTable(){}static setRankData(e){if(Laya.Browser.onMiniGame){var t=[],i={wxgame:{}};i.wxgame.value1=e,i.wxgame.update_time=Laya.Browser.now(),t.push({key:"goldRank",value:JSON.stringify(i)}),wx.setUserCloudStorage({KVDataList:t,success:function(e){},fail:function(e){console.log("-----fail:"+JSON.stringify(e))},complete:function(e){}})}}static aldEventByType(e){Laya.Browser.onMiniGame&&wx.aldSendEvent(e)}static aldEventByTypeParam(e,t,i){Laya.Browser.onMiniGame&&wx.aldSendEvent(e,{param:i})}}p.GUID=1,p.vectorUp=new Laya.Vector3(0,1,0),p.vectorZero=new Laya.Vector3(0,0,0),p.vectorOne=new Laya.Vector3(1,1,1),p.whileColor=new Laya.Vector4(1,1,1,1),p.greenColor=new Laya.Vector4(0,1,0,1),p.yellowColor=new Laya.Vector4(1,1,0,1),function(e){e.share_Offline="离线奖励分享",e.share_Upgrade="用户升级分享",e.share_double_gold="双倍金币分享",e.share_double_speed="双倍速度分享",e.share_manager_upgrade="升级管理员分享",e.share_fly="飞行物分享",e.share_lottery="抽奖分享",e.ald_stage_level="关卡等级",e.ald_horse_level="马等级",e.ald_arrow_level="箭等级",e.ald_earn_level="收益等级",e.ald_newGuide="新手引导完成",e.ald_start_load="开始加载",e.ald_load_complete="加载完成",e.ald_load_time="加载时长",e.ald_share="自愿分享"}(n||(n={}));class f{constructor(){this.enemyIdInfos=[],this.missions=[],this.propIdInfos=[]}initData(e){this.id=JSON.parse(e.id),this.scene=e.scene,this.stage=e.stage,this.hitRate=JSON.parse(e.hitRate);let t=p.splitStrToNum(e.enemyIds,"_");for(let e=0;e<t.length;e++){const i=t[e];let a=new y;a.index=e+1,a.id=i,this.enemyIdInfos.push(a)}if("-1"!==e.propIds){let t=p.splitStrToNum(e.propIds,"_");for(let e=0;e<t.length;e++){const i=t[e];if(-1==i)break;let a=new v;a.index=e+1,a.id=i,this.propIdInfos.push(a)}}let i=p.splitStrToNum(e.missions,"|");for(let e=0;e<i.length;e++){const t=i[e];let a=p.splitStrToNum(t,"_");if(a){let e=new w;e.id=a[0],e.num=a[1],this.missions.push(e)}}}}class y{}class w{}class v{}class C{initData(e){this.id=JSON.parse(e.id),this.res=e.res,this.enemyType=JSON.parse(e.enemyType),this.missionType=JSON.parse(e.missionType),this.isStartExit=1==JSON.parse(e.isStartExit)}}!function(e){e[e.gun=1]="gun",e[e.knife=2]="knife",e[e.gun_knife=3]="gun_knife",e[e.banker=4]="banker",e[e.exit=5]="exit",e[e.giveup=6]="giveup",e[e.move_hostage=7]="move_hostage",e[e.move_exit=8]="move_exit",e[e.boss=9]="boss"}(r||(r={}));class L{initData(e){this.id=JSON.parse(e.id),this.icon=e.icon,this.desc=e.desc,this.missionType=JSON.parse(e.missionType)}}class S{initData(e){this.id=JSON.parse(e.id),this.res=e.res,this.propType=JSON.parse(e.propType),this.damageRange=JSON.parse(e.damageRange),this.damage=JSON.parse(e.damage)}}!function(e){e[e.bomb=1]="bomb"}(l||(l={})),function(e){e.goldData="goldData",e.stageLevelData="stageLevelData",e.loginTime="loginTime"}(h||(h={}));class M{constructor(){this.stageConfigs=[],this.enemyConfigs=[],this.missionConfigs=[],this.propConfigs=[]}init(){this.mGold=0,this.offlineTime=0,this.mStageLevel=1}getCacheStorage(e){return localStorage.getItem(e)}setCacheStorage(e,t){try{localStorage.setItem(e,t)}catch(e){}}loadCache(){var e=this.getCacheStorage(h.goldData);null!=e&&""!=e&&(this.mGold=JSON.parse(e));var t=this.getCacheStorage(h.stageLevelData);null!=t&&""!=t&&(this.mStageLevel=JSON.parse(t));var i=this.getCacheStorage(h.loginTime),a=new Date;let s=a.getTime(),o=a.getDate(),n=a.getMonth();if(null!=i&&""!=i){let e=JSON.parse(i);this.offlineTime=(s-e.time)/1e3}let r={time:s,day:o,month:n,num:1};this.setCacheStorage(h.loginTime,JSON.stringify(r))}addGold(e){e=Math.floor(e),this.mGold+=e,this.setCacheStorage(h.goldData,this.mGold.toString()),u.instance.fire(t.updateGold,this.mGold),u.instance.fire(t.addGold,e)}subGold(e){e=Math.floor(e),this.mGold<e||(this.mGold-=e,this.setCacheStorage(h.goldData,this.mGold.toString()),u.instance.fire(t.updateGold,this.mGold))}nextStage(){this.mStageLevel++,console.log("下一关 ===== "+this.mStageLevel),this.setCacheStorage(h.stageLevelData,this.mStageLevel.toString())}getCurStageConfig(){if(this.stageConfigs.length<this.mStageLevel){let e=this.mStageLevel%10;0==e&&(e=10);let t=this.stageConfigs.length-10+e;return t>this.stageConfigs.length&&(t=this.stageConfigs.length),this.stageConfigs[t-1]}return this.stageConfigs[this.mStageLevel-1]}getStageConfigById(e){return e<=0||e>this.stageConfigs.length?null:this.stageConfigs[e-1]}getEnemyConfig(e){return this.enemyConfigs[e-1]}getMissionConfigById(e){return this.missionConfigs[e-1]}getPropConfigById(e){return this.propConfigs[e-1]}resetGame(){}loadStageConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new f;a.initData(i),this.stageConfigs.push(a)}}loadEnemyConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new C;a.initData(i),this.enemyConfigs.push(a)}}loadMissionConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new L;a.initData(i),this.missionConfigs.push(a)}}loadPropConfig(e){for(let t=0;t<e.length;t++){const i=e[t];let a=new S;a.initData(i),this.propConfigs.push(a)}}}class b{init(){}openScene(e,t,i){null==i&&(i=!0);let a=[t];Laya.Scene.open(e,i,null,Laya.Handler.create(this,this.onOpenCompleteScene,a))}onOpenCompleteScene(e,t){e&&e.runWith(t)}loadScene(e,t){let i=[t];Laya.Scene.load(e,Laya.Handler.create(this,this.onCompleteScene,i))}onCompleteScene(e,t){e&&e.runWith(t)}loadScene3D(e,t){let i=[t];Laya.Scene3D.load(e,Laya.Handler.create(this,this.onCompleteScene3D,i))}onCompleteScene3D(e,t){this.scene3D=t;console.log("scene.reflectionIntensity = "+t.reflectionIntensity),Laya.stage.addChildAt(t,0),e&&e.runWith(t)}}class B{constructor(){}init(){}loadPrefab3D(e,t,i,a){Laya.Sprite3D.load(e,Laya.Handler.create(i,t,a))}loadTexture(e,t){Laya.Texture2D.load(e,t)}loadMaterial(e,t){Laya.BaseMaterial.load(e,t)}load(e,t){Laya.loader.load(e,Laya.Handler.create(this,t))}}class D{constructor(){}init(){}onceExecute(e,t,i,a){e*=1e3,Laya.timer.once(e,t,i,a)}clear(e,t){Laya.timer.clear(e,t)}clearAll(e){Laya.timer.clearAll(e)}loop(e,t,i,a){e*=1e3,Laya.timer.loop(e,t,i,a)}framLoop(e,t,i){Laya.timer.frameLoop(1,e,t,i)}frameOnce(e,t,i){Laya.timer.frameOnce(e,t,i)}}class x{}x.MainView="MainView.scene",x.BattleView="BattleView.scene",x.FailView="FailView.scene",x.VictoryView="VictoryView.scene",x.battleScenePath="unity/Conventional/Battle.ls",x.resRootPath="unity/Conventional/",x.startScene="LoadingView.scene",x.SCREEN_FIT_TOP=60,x.FLY_COIN_TIME=180,x.texPath="tex/",x.cardPoolSign="cardPoolSign",x.rotateCameraX1=-30.3,x.rotateCameraX2=-62.4,x.gid="5ef0b211b4f06b55fe0bf329",x.bid="5ef0b3fcb4f06b55fe0bf32c";class A{constructor(){this.adUnitId_BannerAd="adunit-930f894961022d82",this.adUnitId_RecommendAd="PBgAAfkSVjbG5zPQ",this.adUnitId_VideoAd="adunit-446ea7b2d94863ec"}init(){this.initBannerAd()}initBannerAd(){if(Laya.Browser.onMiniGame){let e=80,t=300,i=wx.getSystemInfoSync();this.bannerAd=wx.createBannerAd({adUnitId:this.adUnitId_BannerAd,adIntervals:30,style:{left:(i.windowWidth-t)/2,top:i.windowHeight-e,width:t}}),this.bannerAd.onResize(e=>{this.bannerAd.style.top=i.windowHeight-this.bannerAd.style.realHeight});this.bannerAd.onLoad(function(){console.log("showBannerAd  成功")}),this.bannerAd.onError(function(e){console.log("showBannerAd  失败"),console.log(e)})}}showGuessLike(){}initRecommendAd(){if(Laya.Browser.onMiniGame){this.mainViewIconAd=null;let e=wx.getSystemInfoSync(),t=270,i=75;wx.createGameIcon&&(this.mainViewIconAd=wx.createGameIcon({adUnitId:this.adUnitId_RecommendAd,count:1,style:[{left:e.windowWidth-i,top:e.windowHeight-t,appNameHidden:!0,color:"#ffffff"}]}))}}initInterstitialAd(){Laya.Browser.onMiniGame&&wx.createInterstitialAd&&(this.interstitialAd=wx.createInterstitialAd({adUnitId:"adunit-95a77896c0c93647"}),this.interstitialAd.onError(function(e){console.log(e)}))}initGridAd(){if(!Laya.Browser.onMiniGame||!wx.createGridAd)return;let e=wx.getSystemInfoSync();this.gridAd=wx.createGridAd({adUnitId:"adunit-287fad9efd2c05d8",adTheme:"white",gridCount:5,style:{left:(e.windowWidth-300)/2,top:e.windowHeight-80,width:300}}),this.gridAd.onResize(t=>{this.gridAd.style.top=e.windowHeight-this.gridAd.style.realHeight}),this.gridAd.onError(function(e){console.log(e)})}showRecommendAdIcon(){Laya.Browser.onMiniGame&&null!=this.mainViewIconAd&&this.mainViewIconAd&&this.mainViewIconAd.show()}hideRecommendAdIcon(){Laya.Browser.onMiniGame&&null!=this.mainViewIconAd&&this.mainViewIconAd&&this.mainViewIconAd.hide()}showInterstitialAd(){Laya.Browser.onMiniGame&&null!=this.interstitialAd&&this.interstitialAd.show().catch(e=>{console.log(e)})}showGridAd(){Laya.Browser.onMiniGame&&null!=this.gridAd&&this.gridAd.show()}hideGridAd(){Laya.Browser.onMiniGame&&null!=this.gridAd&&this.gridAd.hide()}showBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&this.bannerAd.show()}refreshBannerAd(){if(Laya.Browser.onMiniGame){let e=80,t=300,i=wx.getSystemInfoSync();this.bannerAd&&(this.bannerAd.offError(),this.bannerAd.destroy()),this.bannerAd=wx.createBannerAd({adUnitId:this.adUnitId_BannerAd,adIntervals:30,style:{left:(i.windowWidth-t)/2,top:i.windowHeight-e,width:t}}),this.bannerAd.onResize(e=>{this.bannerAd.style.top=i.windowHeight-this.bannerAd.style.realHeight});this.bannerAd.onLoad(function(){console.log("showBannerAd  成功")}),this.bannerAd.onError(function(e){console.log("showBannerAd  失败"),console.log(e)})}}refreshShowBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&(this.refreshBannerAd(),this.bannerAd.show())}hideBannerAd(){Laya.Browser.onMiniGame&&null!=this.bannerAd&&this.refreshBannerAd()}showAd(e,t){if(!Laya.Browser.onMiniGame)return void(e&&e(!0));console.log("开始广告");let i=this.adUnitId_VideoAd;this.RewardedVideoAd=wx.createRewardedVideoAd({adUnitId:i}),this.RewardedVideoAd.onError(function(t){console.log("加载广告失败"+JSON.stringify(t)),a.showToastFail("加载广告失败"),e&&e(!1)});let a=this;this.RewardedVideoAd.offClose(),this.RewardedVideoAd.onClose(function(t){console.log("关闭广告"),t&&t.isEnded||void 0===t?(console.log("视频回调成功"),e&&e(!0)):(console.log("关闭视频无奖励"),a.showToastFail("未看完,无奖励"),e&&e(!1))}),a.RewardedVideoAd.show().catch(function(e){a.RewardedVideoAd.load().then(function(){a.RewardedVideoAd.show()})})}showToastFail(e){let t={title:e,icon:"fail",duration:2e3};wx.showToast(t)}}class P{constructor(){this.isLoadComplete=!1}init(){this.isLoadComplete=!1,this.initSound(),this.initMusic(),this.loadSound()}initSound(){let e=!0;var t=localStorage.getItem("soundCacheOpen");null!=t&&""!=t&&(e=JSON.parse(t)),Laya.SoundManager.soundMuted=!e}setSound(e){localStorage.setItem("soundCacheOpen",JSON.stringify(e)),Laya.SoundManager.soundMuted=!e}initMusic(){let e=!0;var t=localStorage.getItem("musicCacheOpen");null!=t&&""!=t&&(e=JSON.parse(t)),Laya.SoundManager.musicMuted=!e}setMusic(e){localStorage.setItem("musicCacheOpen",JSON.stringify(e)),Laya.SoundManager.musicMuted=!e,e&&this.playMusic("sound/bgm.mp3",0)}playSound(e,t,i,a){if(!this.isLoadComplete)return;let s=Laya.SoundManager.playSound(e,t,null,null,a);s&&i&&(s.volume=i)}playMusic(e,t){this.isLoadComplete&&(Laya.SoundManager.autoStopMusic=!1,Laya.SoundManager.playMusic(e,t))}loadSound(){let e=this;if(Laya.Browser.onMiniGame){wx.loadSubpackage({name:"sound",success:function(t){e.isLoadComplete=!0,e.playMusic("sound/bgm.mp3",0)},fail:function(e){}})}else e.isLoadComplete=!0,e.playMusic("sound/bgm.mp3",0)}}class R{constructor(){console.log("game")}static get instance(){return null==R._instance&&(R._instance=new R),R._instance}init(){this.userData=new M,this.userData.init(),this.eventManager=u.instance,this.eventManager.init(),this.scenesManager=new b,this.scenesManager.init(),this.loadManager=new B,this.loadManager.init(),this.timeManager=new D,this.timeManager.init(),this.soundManager=new P,this.soundManager.init(),this.ad=new A,this.ad.init(),this.loadScene()}loadCacheData(e){}loadScene(){this.scenesManager.openScene(x.startScene,Laya.Handler.create(this,this.onCompleteScene),!0)}loadSubpackageAsyn(){let e=this;wx.loadSubpackage({name:"tex",success:function(i){e.isSubPackageLoadComplete=!0,e.eventManager.fire(t.subPackageLoadComplete)},fail:function(e){}})}onCompleteScene(e){this.log("onCompleteScene"),this.setSceneUI(e)}log(e){console.log(e)}setScene3D(e){this.scene3D=e;let t=e.getChildByName("CameraParent");this.camera=t.getChildByName("Main Camera")}setSceneUI(e){this.sceneUI=e}}class V{constructor(){this.targetAngle=0,this.fieldOfViewMax=77,this.fieldOfViewMin=17,this.tempAngle1=new Laya.Vector3(0,0,0),this.tempV=new Laya.Vector3,this.tempV2=new Laya.Vector3}init(){this.cameraParent=R.instance.scene3D.getChildByName("CameraParent"),this.camera=this.cameraParent.getChildByName("Main Camera"),this.gunRecoilStart=!1,this.fastMoveDirType=o.none,R.instance.eventManager.on(t.ui_openAim,this,this.startAim),R.instance.eventManager.on(t.ui_closeAim,this,this.cancelAim),R.instance.eventManager.on(t.ui_shoot,this,this.shoot),R.instance.eventManager.on(t.reset_Game,this,this.resetGame),R.instance.eventManager.on(t.gameOver,this,this.gameOver)}onLateUpdate(){this.doRecoil(),this.fastMove()}gameOver(){this.fastMoveDirType=o.none}resetGame(){this.cancelAim()}fastMove(){switch(this.fastMoveDirType){case o.none:break;case o.left:this.moveLeft();break;case o.right:this.moveRight()}}moveLeft(){let e=this.cameraParent.transform.localRotationEuler.x,t=this.cameraParent.transform.localRotationEuler.y+10*Laya.timer.delta/1e3;this.tempV.x=e,this.tempV.y=t,this.tempV.z=0,this.setLocalRotationEuler(this.tempV)}moveRight(){let e=this.cameraParent.transform.localRotationEuler.x,t=this.cameraParent.transform.localRotationEuler.y-10*Laya.timer.delta/1e3;this.tempV.x=e,this.tempV.y=t,this.tempV.z=0,this.setLocalRotationEuler(this.tempV)}checkFastMove(e){this.fastMoveDirType=e}setCameraParentPos(e,t){this.cameraParent.transform.position=e,this.cameraParent.transform.rotationEuler=t,this.limitAngleMaxY=this.cameraParent.transform.localRotationEulerY+50,this.limitAngleMinY=this.cameraParent.transform.localRotationEulerY-50,this.limitAngleMaxX=this.cameraParent.transform.localRotationEulerX+30,this.limitAngleMinX=this.cameraParent.transform.localRotationEulerX-30}doRecoil(){this.gunRecoilStart&&(this.tempV.x=this.targetAngle,this.tempV.y=this.cameraParent.transform.localRotationEuler.y,this.tempV.z=0,Laya.Vector3.lerp(this.cameraParent.transform.localRotationEuler,this.tempV,15*Laya.timer.delta/1e3,this.tempV2),this.tempV2.z=0,this.cameraParent.transform.localRotationEuler=this.tempV2)}shoot(){this.gunRecoilStart=!0;let e=this.cameraParent.transform.localRotationEuler.x;this.targetAngle=e-2;let t=this;R.instance.timeManager.onceExecute(.2,this,function(){t.gunRecoilStart=!1,t.tempAngle1.x=t.cameraParent.transform.localRotationEuler.x,t.tempAngle1.y=t.cameraParent.transform.localRotationEuler.y,t.tempAngle1.z=0;Laya.Tween.to(t.tempAngle1,{x:e,update:new Laya.Handler(this,function(){t.tempAngle1.z=0,t.cameraParent.transform.localRotationEuler=t.tempAngle1})},300,null)})}startAim(){Laya.Tween.clearAll(this.camera),Laya.Tween.to(this.camera,{fieldOfView:this.fieldOfViewMin},300,null)}cancelAim(){Laya.Tween.clearAll(this.camera),Laya.Tween.to(this.camera,{fieldOfView:this.fieldOfViewMax},300,null)}moveAim(e,t){let i=this.cameraParent.transform.localRotationEuler.x+t,a=this.cameraParent.transform.localRotationEuler.y+e;this.tempV.x=i,this.tempV.y=a,this.tempV.z=0,Laya.Vector3.lerp(this.cameraParent.transform.localRotationEuler,this.tempV,1*Laya.timer.delta/1e3,this.tempV2),this.setLocalRotationEuler(this.tempV2)}setLocalRotationEuler(e){e.y>this.limitAngleMaxY&&(e.y=this.limitAngleMaxY),e.y<this.limitAngleMinY&&(e.y=this.limitAngleMinY),e.x>this.limitAngleMaxX&&(e.x=this.limitAngleMaxX),e.x<this.limitAngleMinX&&(e.x=this.limitAngleMinX),this.cameraParent.transform.localRotationEuler=e,$.instance.heroManager.updateRatote(e)}}class I extends Laya.Script3D{init(e){this.damageCallBack=e}damage(e){this.damageCallBack&&this.damageCallBack(e)}}class T extends Laya.Script3D{constructor(){super()}onDisable(){R.instance.timeManager.clearAll(this)}onDestroy(){R.instance.timeManager.clearAll(this),this.owner=null}init(e,t){this.recycleType=t,R.instance.timeManager.onceExecute(e,this,this.recycle)}recycle(){switch(this.recycleType){case i.bullet:k.instance.recycleBulletRes(this.owner);break;case i.hitEffect:k.instance.recycleHitEffectRes(this.owner);break;case i.bombEffect:k.instance.recycleBombEffectRes(this.owner)}}}class k{constructor(){k._instance=this}static get instance(){return k._instance}init(){this.hitEffect=R.instance.scene3D.getChildByName("hitEffect"),this.bullet=R.instance.scene3D.getChildByName("bullet"),this.bombEffect=R.instance.scene3D.getChildByName("bombEffect"),this.hitEffect.active=!1,this.bullet.active=!1,this.bombEffect.active=!1}addAutoRecycleScr(e,t,i){let a=e.getComponent(T);null==a&&(a=e.addComponent(T)),a.init(t,i)}getHitEffectRes(){let e=Laya.Pool.getItem("hitEffectPool");return null==e&&(e=Laya.Sprite3D.instantiate(this.hitEffect)),e.active=!0,e}recycleHitEffectRes(e){e&&(e.removeSelf(),Laya.Pool.recover("hitEffectPool",e))}getBombEffectRes(){let e=Laya.Pool.getItem("bombEffectPool");return null==e&&(e=Laya.Sprite3D.instantiate(this.bombEffect)),e.active=!0,e}recycleBombEffectRes(e){e&&(e.removeSelf(),Laya.Pool.recover("bombEffectPool",e))}getBulletRes(){let e=Laya.Pool.getItem("bulletPool");return null==e&&(e=Laya.Sprite3D.instantiate(this.bullet)),e}recycleBulletRes(e){e&&(e.transform.localScale=p.vectorOne,e.removeSelf(),Laya.Pool.recover("bulletPool",e))}}class E extends Laya.Script3D{constructor(){super(),this.moveSpeed=150,this.isMove=!1}init(e,t,i,a){this.moveDir=new Laya.Vector3,this.tempDir=new Laya.Vector3,this.moveDis=t,this.curMoveDis=0,this.isMove=!0,this.hitResult=i,this.damageNum=a,Laya.Vector3.normalize(e,this.moveDir);this.owner.getChildByName("Trail")}onUpdate(){this.isMove&&this.doMove()}doMove(){let e=Laya.timer.delta*this.moveSpeed/1e3;this.curMoveDis+=e,Laya.Vector3.scale(this.moveDir,e,this.tempDir),this.owner.transform.translate(this.tempDir,!1),this.curMoveDis>=this.moveDis&&(this.isMove=!1,this.shootComplete())}shootComplete(){if(this.hitResult.succeeded&&this.hitResult.collider.owner){let e=k.instance.getHitEffectRes();this.hitResult.collider.owner.addChild(e),e.transform.position=this.hitResult.point,e.transform.setWorldLossyScale(p.vectorOne),k.instance.addAutoRecycleScr(e,.5,i.hitEffect),e.active=!0;let t=this.hitResult.collider.owner.getComponent(I);if(t){let e=!1,i=1;if("bodyHit"==this.hitResult.collider.owner.name||"headHit"==this.hitResult.collider.owner.name){if("headHit"==this.hitResult.collider.owner.name){e=!0,i=2;let t=this;R.instance.timeManager.onceExecute(.2,this,function(){t.showHeadShoot()})}this.showDamage(e)}t.damage(this.damageNum*i)}}let e=this.owner.getChildByName("mesh");e&&(e.active=!1);let t=this;R.instance.timeManager.onceExecute(.5,this,function(){e&&(e.active=!0)});R.instance.timeManager.onceExecute(1,this,function(){t.clearData()})}showDamage(e){let t=e?2*this.damageNum:this.damageNum;this.damageNoticeLabel=new Laya.Label,this.damageNoticeLabel.font="Microsoft YaHei",this.damageNoticeLabel.text=t.toString(),this.damageNoticeLabel.fontSize=50,this.damageNoticeLabel.bold=!0,this.damageNoticeLabel.anchorX=.5,this.damageNoticeLabel.anchorY=.5,this.damageNoticeLabel.stroke=2,this.damageNoticeLabel.strokeColor="#000000",this.damageNoticeLabel.color=e?"#ff0400":"#e2e2e2",Laya.stage.addChild(this.damageNoticeLabel);let i=.5*Laya.stage.height-50;this.damageNoticeLabel.pos(.5*Laya.stage.width,i);let a=i-100,s=this;Laya.Tween.to(this.damageNoticeLabel,{y:a},300,null,Laya.Handler.create(this,function(){s.damageNoticeLabel.visible=!1}))}showHeadShoot(){this.headShotLabel=new Laya.Label,this.headShotLabel.font="Microsoft YaHei",this.headShotLabel.text="爆 头!",this.headShotLabel.fontSize=35,this.headShotLabel.bold=!0,this.headShotLabel.anchorX=.5,this.headShotLabel.anchorY=.5,this.headShotLabel.stroke=2,this.headShotLabel.strokeColor="#000000",this.headShotLabel.color="#e2e2e2",Laya.stage.addChild(this.headShotLabel);let e=.5*Laya.stage.height-50;this.headShotLabel.pos(.5*Laya.stage.width,e);let t=e-80,i=this;Laya.Tween.to(this.headShotLabel,{y:t},300,null,Laya.Handler.create(this,function(){i.headShotLabel.visible=!1}))}clearData(){this.owner&&k.instance.recycleBulletRes(this.owner),this.damageNoticeLabel&&(this.damageNoticeLabel.removeSelf(),this.damageNoticeLabel.destroy()),this.headShotLabel&&(this.headShotLabel.removeSelf(),this.headShotLabel.destroy()),this.destroy(),this.owner=null}}class _{constructor(){this.blood=100,this.bloodBase=100,this.rayHitResult=new Laya.HitResult,this.aimRay=new Laya.Ray(new Laya.Vector3,new Laya.Vector3),this.tempDir=new Laya.Vector3,this.tempDir1=new Laya.Vector3,this.tempDir2=new Laya.Vector3,this.tempMousePos=new Laya.Vector2,this.tempPos=new Laya.Vector3}init(){this.heroObj=R.instance.scene3D.getChildByName("hero"),this.heroObj.active=!1;let e=this.heroObj.getChildByName("root");this.animCtr=e.getComponent(Laya.Animator),R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),this.blood=this.bloodBase}resetGame(){this.blood=this.bloodBase}reload(){let e=this;R.instance.timeManager.onceExecute(1.5,this,function(){e.animCtr.crossFade("Reload",.1,0),R.instance.soundManager.playSound("sound/reload.mp3")}),R.instance.timeManager.onceExecute(3,this,function(){e.animCtr.crossFade("Idle",.1,0)})}damage(e,i){this.blood<=0||(this.blood-=e,R.instance.eventManager.fire(t.hero_bloodUpdate,i),this.blood<=0&&$.instance.gameOver(s.shooted))}stageLoadComplete(){let e=$.instance.stageManager.stageRes.getChildByName("HeroSpots");this.heroObj.transform.position=e.transform.position,this.heroObj.active=!0,this.heroObj.transform.rotationEuler=e.transform.rotationEuler,$.instance.cameraLogic.setCameraParentPos(this.heroObj.transform.position,this.heroObj.transform.rotationEuler),this.resetGame()}getHeroPos(){return this.heroObj.transform.position}shoot(){let e=.5*Laya.stage.width,t=.5*Laya.stage.height;(Laya.Browser.onQGMiniGame||Laya.Browser.onQQMiniGame||Laya.Browser.onVVMiniGame)&&(e=.5*Laya.Browser.width,t=.5*Laya.Browser.height);let i=$.instance.cameraLogic.camera.transform.position,a=Laya.Sprite3D.instantiate($.instance.bullet);R.instance.scene3D.addChild(a),a.transform.position=i,a.active=!0,this.tempMousePos.x=e,this.tempMousePos.y=t,$.instance.cameraLogic.camera.viewportPointToRay(this.tempMousePos,this.aimRay),R.instance.scene3D.physicsSimulation.rayCast(this.aimRay,this.rayHitResult,100);let s=100;this.rayHitResult.succeeded?(Laya.Vector3.subtract(this.rayHitResult.point,a.transform.position,this.tempDir),s=Laya.Vector3.scalarLength(this.tempDir)):(Laya.Vector3.scale(this.aimRay.direction,100,this.tempDir1),Laya.Vector3.subtract(i,a.transform.position,this.tempDir2),Laya.Vector3.add(this.tempDir1,this.tempDir2,this.tempDir));let o=this.tempDir;this.tempDir1.x=-o.x+a.transform.position.x,this.tempDir1.y=-o.y+a.transform.position.y,this.tempDir1.z=-o.z+a.transform.position.z,a.transform.lookAt(this.tempDir1,p.vectorUp,!1),a.addComponent(E).init(this.tempDir,s,this.rayHitResult,70),R.instance.soundManager.playSound("sound/shot.mp3")}getAttackHeroPos(e){let t=this.heroObj.transform.position,i=1,a=1.1,s=i,o=a;return e?(i=.2,a=.3,s=p.random(0,100*i)/100-i/2,o=p.random(0,100*a)/100+.5):(s=p.random(0,100*i)/100-i/2)<=.1&&s>=-.1?(o=.3+a,s=i):o=p.random(0,100*a)/100+.5,this.tempPos.x=t.x+s,this.tempPos.y=t.y+o,this.tempPos.z=t.z,this.tempPos}updateRatote(e){this.heroObj.transform.localRotationEuler=e}}class G{constructor(){this.isHadTriggerFight=!1}init(){this.curStageConfig=R.instance.userData.getCurStageConfig(),this.isHadTriggerFight=!1,this.sceneRes=null,this.loadScene(!0),R.instance.eventManager.on(t.reset_Game,this,this.resetGame)}resetGame(){this.curStageConfig=R.instance.userData.getCurStageConfig(),this.isHadTriggerFight=!1,this.stageRes.removeSelf(),this.stageRes.destroy(),this.stageRes=null,this.loadScene(!1)}loadScene(e){if(!e&&this.curStageConfig.id>15){let e=R.instance.userData.getStageConfigById(this.curStageConfig.id-1);if(e&&e.scene==this.curStageConfig.scene)return console.log("不加载场景  直接加载  关卡 "),void this.loadStage()}console.log("加载 新 场景 "),this.sceneRes&&(this.sceneRes.removeSelf(),this.sceneRes.destroy());let t=this.getPrefabPath(this.curStageConfig.scene);R.instance.loadManager.loadPrefab3D(t,function(e){this.sceneRes=e,R.instance.scene3D.addChild(e),this.loadStage(),Laya.Resource.destroyUnusedResources()},this)}loadStage(){let e=this.getPrefabPath(this.curStageConfig.stage);R.instance.loadManager.loadPrefab3D(e,function(e){this.stageRes=e,R.instance.scene3D.addChild(e),Laya.Resource.destroyUnusedResources(),R.instance.eventManager.fire(t.stage_loadComplete),this.setTrigger()},this)}getPrefabPath(e){return x.resRootPath+e+".lh"}setTrigger(){this.isHadTriggerFight=!1;let e=this.stageRes.getChildByName("Triggers"),t=this,i=function(e){t.triggerFight()};for(let t=0;t<e.numChildren;t++){e.getChildAt(t).addComponent(I).init(i)}}triggerFight(){this.isHadTriggerFight||(this.isHadTriggerFight=!0,R.instance.eventManager.fire(t.stage_triggerFight))}checkIsShootDamage(){return p.random(1,100)<=this.curStageConfig.hitRate}}class N extends Laya.Script3D{constructor(){super(),this.moveSpeed=100,this.isMove=!1,this.isDamage=!1}init(e,t,i,a){this.startPos=a,this.moveDir=new Laya.Vector3,this.tempDir=new Laya.Vector3,this.tempZ=new Laya.Vector3(0,0,1),this.moveDis=t,this.curMoveDis=0,this.isMove=!0,this.isDamage=i,this.moveSpeed=100,Laya.Vector3.normalize(e,this.moveDir)}onDisable(){}onUpdate(){this.isMove&&this.doMove()}doMove(){let e=Laya.timer.delta*this.moveSpeed/1e3;this.curMoveDis+=e,Laya.Vector3.scale(this.moveDir,e,this.tempDir),this.owner.transform.translate(this.tempDir,!1),this.curMoveDis>=this.moveDis&&(this.isMove=!1,this.shootComplete())}shootComplete(){}clearData(){this.owner&&(this.owner.active=!1,k.instance.recycleBulletRes(this.owner)),this.isMove=!1,this.destroy(),this.owner=null}}class O extends N{constructor(){super()}init(e,t,i,a){super.init(e,t,i,a);let s=this.owner.getChildByName("Trail");s&&(s.active=!0)}shootComplete(){let e=k.instance.getHitEffectRes();$.instance.heroManager.getHeroPos();R.instance.scene3D.addChild(e),e.transform.position=this.owner.transform.position,k.instance.addAutoRecycleScr(e,.5,i.hitEffect),e.active=!0;let t=this.owner.getChildByName("mesh");t&&(t.active=!1);let a=this;R.instance.timeManager.onceExecute(.5,this,function(){t&&(t.active=!0),a.clearData()}),this.isDamage&&$.instance.heroManager.damage(23,this.startPos)}}class U{constructor(){this.isDestroy=!1,this.offsetY=50}init(e){this.owner=e,this.isDestroy=!1,this.progress=null,R.instance.timeManager.framLoop(this,this.updateBlood)}updateBlood(){if(!this.isDestroy&&null!=this.owner&&null!=this.owner.owner)if(this.owner.blood<=0)this.clearData();else if(this.owner.blood>0&&this.owner.blood<this.owner.bloodBase){null==this.progress&&this.createProgress();let e=this.owner.blood/this.owner.bloodBase;this.updateSize(),this.updatePos(),this.progress.value=e}}updateSize(){let e=$.instance.cameraLogic.camera.fieldOfView,t=$.instance.cameraLogic.fieldOfViewMax-$.instance.cameraLogic.fieldOfViewMin,i=(e-$.instance.cameraLogic.fieldOfViewMin)/t,a=1-.5*i;this.progress.scaleX=.6*a,this.progress.scaleY=.6*a;this.offsetY=50+170*(1-i)}updatePos(){let e=new Laya.Vector4,t=this.owner.owner.transform.position;R.instance.camera.worldToViewportPoint(t,e),this.progress.pos(e.x,e.y-this.offsetY)}createProgress(){this.progress=new Laya.ProgressBar("UI/bloodProgress.png"),this.progress.sizeGrid="0,22,0,16",this.progress.anchorX=.5,this.progress.anchorY=.5,this.progress.alpha=.7,Laya.stage.addChildAt(this.progress,1)}clearData(){this.isDestroy=!0,this.progress&&(this.progress.removeSelf(),this.progress.destroy()),this.progress=null,R.instance.timeManager.clearAll(this)}}class H{constructor(){this.blood=100,this.bloodBase=100,this.shootMovePath=[],this.idleMovePath=[],this.hudBloodLogic=null}init(e,i){this.enemyCfg=e,this.spotsParent=i,this.isDead=!1,this.blood=this.bloodBase,this.shootMovePath=[],this.idleMovePath=[],R.instance.eventManager.on(t.stage_triggerFight,this,this.triggerFightStart),this.loadEnemy()}clearData(){R.instance.timeManager.clearAll(this),R.instance.eventManager.off(t.stage_triggerFight,this,this.triggerFightStart),this.headRoleBoxScript&&this.headRoleBoxScript.destroy(),this.bodyRoleBoxScript&&this.bodyRoleBoxScript.destroy(),this.owner&&(this.owner.removeSelf(),this.owner.destroy()),this.spotsParent=null,this.owner=null,this.animCtrl=null,this.headObj=null,this.bodyObj=null,this.headRoleBoxScript=null,this.bodyRoleBoxScript=null,this.hudBloodLogic.clearData(),this.hudBloodLogic=null}loadEnemy(){let e=this.getPrefabPath(this.enemyCfg.res);R.instance.loadManager.loadPrefab3D(e,function(e){e=Laya.Sprite3D.instantiate(e),R.instance.scene3D.addChild(e),this.loadComplete(e)},this)}getPrefabPath(e){return x.resRootPath+e+".lh"}loadComplete(e){this.owner=e;let t=this.spotsParent.getChildByName("enemySpots1");this.owner.transform.position=t.transform.position,this.owner.transform.rotationEuler=t.transform.rotationEuler,this.owner.active=!0,this.headObj=p.findChildByName(this.owner,"headHit"),this.bodyObj=this.owner.getChildByName("bodyHit");let i=this.owner.getChildByName("root");this.animCtrl=i.getComponent(Laya.Animator),this.setBoxScript(),this.setShootSpots(),this.setIdleMoveSpots(),this.showWeapon(),this.showHUDBlood()}showHUDBlood(){this.hudBloodLogic=new U,this.hudBloodLogic.init(this)}showWeapon(){switch(this.enemyCfg.enemyType){case r.gun:let e=p.findChildByName(this.owner,"GunRoot");e&&(e.active=!0);let t=p.findChildByName(this.owner,"KnifeLeft");t&&(t.active=!1);break;case r.knife:let i=p.findChildByName(this.owner,"GunRoot");i&&(i.active=!1);let a=p.findChildByName(this.owner,"KnifeLeft");a&&(a.active=!0)}}setShootSpots(){let e=this.spotsParent.getChildByName("shootSpots");if(e)for(let t=0;t<e.numChildren;t++){let i=e.getChildAt(t);this.shootMovePath.push(i.transform.position)}}setIdleMoveSpots(){let e=this.spotsParent.getChildByName("moveSpots");if(e)for(let t=0;t<e.numChildren;t++){let i=e.getChildAt(t);this.idleMovePath.push(i.transform.position)}}setBoxScript(){let e=this,t=function(t){e.damage(t)};this.headObj&&(this.headRoleBoxScript=this.headObj.addComponent(I),this.headRoleBoxScript.init(t)),this.bodyObj&&(this.bodyRoleBoxScript=this.bodyObj.addComponent(I),this.bodyRoleBoxScript.init(t))}damage(e){$.instance.isGameOver||this.isDead||null==this.owner||(this.blood-=e,this.blood<=0?this.dead():this.hited(),$.instance.stageManager.triggerFight())}hited(){let e=this.animCtrl.getCurrentAnimatorPlayState().animatorState.name;this.animCtrl.play("Hited",0);let t=this;R.instance.timeManager.onceExecute(.5,this,function(){t.animCtrl.crossFade(e,.1,0,0)})}dead(){this.isDead=!0,this.animCtrl.crossFade("Dead",.1,0,0)}triggerFight(){}triggerFightStart(){if(this.isDead)return;this.animCtrl.crossFade("Surprised",.1,0,0);let e=this;R.instance.timeManager.onceExecute(1,this,function(){e.isDead||e.triggerFight()})}}class F extends H{constructor(){super(...arguments),this.isMoveComplete=!1,this.movePath=[],this.curMoveIndex=0,this.moveSpeed=1.5,this.runSpeed=1.5,this.walkSpeed=.5,this.pauseWalkCallback=null,this.curIdleWalkIndex=0,this.idleWalkTempV=new Laya.Vector3,this.moveTempV=new Laya.Vector3,this.moveTempAngle=new Laya.Vector3}init(e,t){super.init(e,t),this.movePath=[],this.isStartMove=!1,this.isStartIdleWalk=!1,this.isMoveComplete=!1;let i=this;this.curIdleWalkIndex=0,this.pauseWalkCallback=function(){i.animCtrl.play("Walk"),i.idleWalk()}}triggerFight(){if(!this.isDead){this.movePath=[];for(let e=0;e<this.shootMovePath.length;e++){const t=this.shootMovePath[e];this.movePath.push(t)}this.curMoveIndex=0,this.changeToRun()}}changeToRun(){this.overIdleWalk(),this.isStartMove=!0,this.animCtrl.play("Run"),this.moveSpeed=this.runSpeed,Laya.Tween.clearAll(this.moveTempV),this.move()}changeToIdleWalk(){this.curIdleWalkIndex=0,this.isStartIdleWalk=!0,this.animCtrl.play("Walk"),this.moveSpeed=this.walkSpeed,this.movePath=[];for(let e=0;e<this.idleMovePath.length;e++){const t=this.idleMovePath[e];this.movePath.push(t)}this.idleWalk()}overIdleWalk(){this.isStartIdleWalk=!1,this.animCtrl.play("Idle"),Laya.Tween.clearAll(this.idleWalkTempV),R.instance.timeManager.clear(this,this.pauseWalkCallback)}idleWalk(){if(!this.isStartIdleWalk||this.movePath.length<=this.curIdleWalkIndex)return;let e=this.movePath[this.curIdleWalkIndex],t=this.owner.transform.position,i=1e3*Laya.Vector3.distance(e,t)/this.moveSpeed;this.idleWalkTempV=t;Laya.Tween.to(this.idleWalkTempV,{x:e.x,y:e.y,z:e.z,update:new Laya.Handler(this,function(){this.owner.transform.position=this.idleWalkTempV})},i,null,Laya.Handler.create(this,function(){this.curIdleWalkIndex++,this.movePath.length<=this.curIdleWalkIndex?(console.log("所有点 移动完成"),this.idleWalkComplete()):(console.log("移动完一个点   原地待一会儿"),this.idleWalkCompletePoint())})),this.doRotateToPos(e)}idleWalkCompletePoint(){this.animCtrl.play("Idle"),R.instance.timeManager.onceExecute(3,this,this.pauseWalkCallback)}idleWalkComplete(){this.animCtrl.play("Idle")}move(e){if(!this.isStartMove||this.movePath.length<=this.curMoveIndex)return;let t=this.movePath[this.curMoveIndex],i=this.owner.transform.position,a=1e3*Laya.Vector3.distance(t,i)/this.moveSpeed;this.moveTempV=i;Laya.Tween.to(this.moveTempV,{x:t.x,y:t.y,z:t.z,update:new Laya.Handler(this,function(){this.owner.transform.position=this.moveTempV})},a,null,Laya.Handler.create(this,function(){this.curMoveIndex++,this.movePath.length<=this.curMoveIndex?this.moveComplete():e?(console.log("移动完一个点   原地待一会儿"),this.animCtrl.play("Idle"),R.instance.timeManager.onceExecute(3,this,this.pauseWalkCallback)):this.move()})),this.doRotateToPos(t)}doRotateToPos(e){let t=this.owner.transform.position,i=90-Laya.MathUtil.getRotation(t.x,t.z,e.x,e.z);this.moveTempAngle=this.owner.transform.localRotationEuler;let a=this.owner.transform.localRotationEuler.y,s=i-a;Math.abs(s)>=180&&(s=p.changeAngleTo360(s))>=180&&(s-=360),i=s+a;Laya.Tween.to(this.moveTempAngle,{y:i,update:new Laya.Handler(this,function(){this.owner.transform.localRotationEuler=this.moveTempAngle})},300,null)}pauseRun(){this.isStartMove=!1,Laya.Tween.clearAll(this.moveTempV)}continueRun(){this.isStartMove=!0,this.animCtrl.play("Run"),this.moveSpeed=this.runSpeed,this.move()}moveComplete(){this.isMoveComplete=!0,this.isStartMove=!1,this.animCtrl.play("Idle")}dead(){Laya.Tween.clearAll(this.moveTempAngle),Laya.Tween.clearAll(this.moveTempV),R.instance.timeManager.clearAll(this),this.isStartIdleWalk=!1,Laya.Tween.clearAll(this.idleWalkTempV),R.instance.timeManager.clear(this,this.pauseWalkCallback),super.dead(),R.instance.eventManager.fire(t.stage_enemyDead,this)}hited(){let e=this.isStartMove;this.isStartMove&&(this.isStartMove=!1,Laya.Tween.clearAll(this.moveTempV)),console.log("被射击");let t=this.animCtrl.getCurrentAnimatorPlayState().animatorState.name;this.animCtrl.play("Hited",0);let i=this;R.instance.timeManager.onceExecute(.5,this,function(){i.animCtrl.crossFade(t,.1,0,0),e&&i.changeToRun()})}clearData(){Laya.Tween.clearAll(this.moveTempAngle),Laya.Tween.clearAll(this.moveTempV),Laya.Tween.clearAll(this.idleWalkTempV),super.clearData()}}class W extends F{constructor(){super(...arguments),this.isStartShoot=!1,this.shootInterval=1e3,this.curShootTime=0,this.tempDir=new Laya.Vector3,this.tempDir1=new Laya.Vector3}init(e,i){super.init(e,i),this.isStartShoot=!1,R.instance.timeManager.framLoop(this,this.update),this.shootInterval=p.random(3e3,5e3),R.instance.eventManager.on(t.gameOver,this,this.gameOver)}gameOver(){this.isStartShoot=!1}loadComplete(e){super.loadComplete(e),this.gunRoot=p.findChildByName(this.owner,"GunRoot")}update(){this.isDead||this.checkShoot()}changeToShoot(){this.isStartShoot=!0,this.animCtrl.play("Shoot"),this.doRotateToPos($.instance.heroManager.getHeroPos())}moveComplete(){super.moveComplete(),this.changeToShoot()}triggerFight(){this.isDead||(this.shootMovePath.length<=0?this.changeToShoot():super.triggerFight())}checkShoot(){this.isStartShoot&&(this.curShootTime+=Laya.timer.delta,this.curShootTime>=this.shootInterval&&(this.curShootTime=0,this.doShoot()))}doShoot(){if(this.isDead)return;let e=k.instance.getBulletRes();R.instance.scene3D.addChild(e),e.transform.position=this.gunRoot.transform.position,e.active=!0;let t=$.instance.stageManager.checkIsShootDamage();this.tempDir1=$.instance.heroManager.getAttackHeroPos(t),Laya.Vector3.subtract(this.tempDir1,e.transform.position,this.tempDir);let i=Laya.Vector3.scalarLength(this.tempDir),a=this.tempDir;this.tempDir1.x=-a.x+e.transform.position.x,this.tempDir1.y=-a.y+e.transform.position.y,this.tempDir1.z=-a.z+e.transform.position.z,e.transform.lookAt(this.tempDir1,p.vectorUp,!1),e.addComponent(O).init(this.tempDir,i,t,this.owner.transform.position),R.instance.soundManager.playSound("sound/enemyShot.mp3")}clearData(){R.instance.eventManager.off(t.gameOver,this,this.gameOver),super.clearData()}}class j extends F{init(e,t){this.bloodBase=1,super.init(e,t)}loadComplete(e){super.loadComplete(e),this.enemyCfg.enemyType==r.giveup?this.animCtrl.play("GiveUp"):this.enemyCfg.enemyType==r.move_hostage&&this.changeToIdleWalk()}triggerFight(){this.shootMovePath.length<=0||super.triggerFight()}moveComplete(){super.moveComplete(),this.animCtrl.play("Idle"),this.doRotateToPos($.instance.heroManager.getHeroPos())}clearData(){super.clearData()}}class z extends F{init(e,i){super.init(e,i),R.instance.eventManager.on(t.startGame,this,this.startGame)}startGame(){this.enemyCfg.isStartExit?this.startEscape():this.enemyCfg.enemyType==r.move_exit&&this.changeToIdleWalk()}startEscape(){if(!(this.isDead||this.shootMovePath.length<=0)){this.movePath=[];for(let e=0;e<this.shootMovePath.length;e++){const t=this.shootMovePath[e];this.movePath.push(t)}this.curMoveIndex=0,this.isStartMove=!0,this.animCtrl.play("Walk"),this.moveSpeed=this.walkSpeed,this.move()}}triggerFight(){this.shootMovePath.length<=0||(this.isStartMove?this.changeToRun():super.triggerFight())}moveComplete(){super.moveComplete(),this.animCtrl.play("Idle"),R.instance.timeManager.onceExecute(.6,this,function(){console.log("任务失败，目标逃跑了"),$.instance.gameOver(s.enemy_escape)})}clearData(){R.instance.eventManager.off(t.startGame,this,this.startGame),super.clearData()}}class J extends W{constructor(){super(...arguments),this.curShootIndex=0,this.isStartMoveShootPoint=!1,this.bossSpotsPaths=[],this.bossSpotsPath=[]}init(e,t){this.bloodBase=800,super.init(e,t),this.shootInterval=p.random(1e3,2e3),this.curShootIndex=0,this.isStartMoveShootPoint=!1}loadComplete(e){super.loadComplete(e),this.owner.transform.localScale=new Laya.Vector3(1.1,1.1,1.1),this.setBossShootSpots(),this.changeToIdleWalk()}setBossShootSpots(){for(let e=0;e<5;e++){let t=e+1,i=this.spotsParent.getChildByName("bossSpots"+t);if(!i)return;let a=[];for(let e=0;e<i.numChildren;e++){let t=i.getChildAt(e);a.push(t.transform.position)}this.bossSpotsPaths.push(a)}}idleWalkComplete(){super.idleWalkComplete(),this.changeToIdleWalk()}damage(e){let t=this.blood/this.bloodBase;super.damage(e);let i=this.blood/this.bloodBase;t>=.6&&i<=.6?this.changeToMoveShot():t>=.3&&i<=.3&&this.changeToMoveShot()}changeToMoveShot(){if(!(this.isDead||this.curShootIndex>=this.bossSpotsPaths.length)){this.isStartShoot=!1,this.movePath=[];for(let e=0;e<this.bossSpotsPaths[this.curShootIndex].length;e++){const t=this.bossSpotsPaths[this.curShootIndex][e];this.movePath.push(t)}this.curMoveIndex=0,this.changeToRun(),this.curShootIndex++,this.isStartMoveShootPoint=!0}}moveComplete(){this.isStartMoveShootPoint=!1,super.moveComplete()}hited(){this.animCtrl.getCurrentAnimatorPlayState().animatorState.name;this.animCtrl.play("Hited",0);let e=this.isStartMove;this.isStartMove&&!this.isStartMoveShootPoint&&this.pauseRun();let t=this;R.instance.timeManager.onceExecute(.5,this,function(){t.isStartShoot?t.animCtrl.play("Shoot"):e&&!t.isStartMoveShootPoint?(t.continueRun(),t.animCtrl.crossFade("Run",.1,0,0)):t.isStartMoveShootPoint?t.animCtrl.crossFade("Run",.1,0,0):t.animCtrl.crossFade("Idle",.1,0,0)})}}class Y{constructor(){this.enemys=[],this.hostages=[]}init(){R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),R.instance.eventManager.on(t.stage_enemyDead,this,this.deadEnemy),R.instance.eventManager.on(t.reset_Game,this,this.resetGame)}stageLoadComplete(){this.curStageConfig=R.instance.userData.getCurStageConfig();let e=this.curStageConfig.enemyIdInfos;for(let t=0;t<e.length;t++){const i=e[t];this.loadEnemy(i)}}loadEnemy(e){let t=$.instance.stageManager.stageRes,i="enemy"+e.index,a=t.getChildByName(i);if(!a)return void console.log("表里面的敌人数量 和  预制里面敌人数量不一致   index === "+e.index);let s=R.instance.userData.getEnemyConfig(e.id),o=null;switch(s.enemyType){case r.gun:case r.gun_knife:(o=new W).init(s,a),this.enemys.push(o);break;case r.knife:(o=new z).init(s,a),this.enemys.push(o);break;case r.move_exit:case r.exit:(o=new z).init(s,a),this.enemys.push(o);break;case r.move_hostage:case r.banker:case r.giveup:(o=new j).init(s,a),this.hostages.push(o);break;case r.boss:(o=new J).init(s,a),this.enemys.push(o)}}deadEnemy(e){e.enemyCfg.enemyType!=r.banker&&e.enemyCfg.enemyType!=r.move_hostage&&e.enemyCfg.enemyType!=r.giveup||(console.log("失败了   人质被打了"),$.instance.gameOver(s.hostage_shooted))}resetGame(){for(let e=0;e<this.enemys.length;e++){this.enemys[e].clearData()}this.enemys=[];for(let e=0;e<this.hostages.length;e++){this.hostages[e].clearData()}this.hostages=[]}propDamage(e){for(let t=0;t<this.enemys.length;t++){const i=this.enemys[t];Laya.Vector3.distance(i.owner.transform.position,e.owner.transform.position)<=e.propCfg.damageRange&&i.damage(e.propCfg.damage)}for(let t=0;t<this.hostages.length;t++){const i=this.hostages[t];Laya.Vector3.distance(i.owner.transform.position,e.owner.transform.position)<=e.propCfg.damageRange&&i.damage(e.propCfg.damage)}}}class X{init(e,t){this.missionCfg=e,this.missionState=c.start,this.progressNum=0,this.missionNum=t}updateProgress(){this.missionState!=c.complete&&(this.progressNum++,R.instance.eventManager.fire(t.missionUpdateProgress,this),this.progressNum>=this.missionNum&&this.completeMission())}completeMission(){this.missionState=c.complete,R.instance.eventManager.fire(t.missionStateComplete,this)}}!function(e){e[e.start=1]="start",e[e.complete=2]="complete"}(c||(c={}));class Q{constructor(){this.allMissionInfos=[]}init(){this.createMission(),R.instance.eventManager.on(t.stage_enemyDead,this,this.deadEnemy),R.instance.eventManager.on(t.reset_Game,this,this.resetGame)}resetGame(){this.allMissionInfos=[],this.createMission()}createMission(){let e=R.instance.userData.getCurStageConfig().missions;for(let t=0;t<e.length;t++){const i=e[t];let a=R.instance.userData.getMissionConfigById(i.id),s=new X;s.init(a,i.num),this.allMissionInfos.push(s)}}deadEnemy(e){for(let t=0;t<this.allMissionInfos.length;t++){const i=this.allMissionInfos[t];e.enemyCfg.missionType==i.missionCfg.missionType&&i.updateProgress()}this.checkMission()}checkMission(){for(let e=0;e<this.allMissionInfos.length;e++){if(this.allMissionInfos[e].missionState!==c.complete)return}console.log("所有任务完成  游戏 胜利"),$.instance.gameOver(s.Win)}}class q{init(e,t){this.propCfg=e,this.spots=t,this.loadProp()}loadProp(){let e=this.getPrefabPath(this.propCfg.res);R.instance.loadManager.loadPrefab3D(e,function(e){e=Laya.Sprite3D.instantiate(e),R.instance.scene3D.addChild(e),this.loadComplete(e)},this)}getPrefabPath(e){return x.resRootPath+e+".lh"}loadComplete(e){this.owner=e,this.owner.transform.position=this.spots.transform.position,this.owner.transform.rotationEuler=this.spots.transform.rotationEuler,this.owner.active=!0;let t=this.owner.getChildByName("hitBox"),i=this,a=function(e){i.damage(e)};t&&(this.bodyRoleBoxScript=t.addComponent(I),this.bodyRoleBoxScript.init(a))}damage(e){console.log("我是道具  被打了")}clearData(){R.instance.timeManager.clearAll(this),this.bodyRoleBoxScript&&this.bodyRoleBoxScript.destroy(),this.owner&&(this.owner.removeSelf(),this.owner.destroy()),this.spots=null,this.owner=null,this.bodyRoleBoxScript=null}}class K extends q{init(e,t){super.init(e,t)}damage(e){super.damage(e),this.doBomb()}doBomb(){let e=k.instance.getBombEffectRes();R.instance.scene3D.addChild(e),e.transform.position=this.owner.transform.position,e.transform.setWorldLossyScale(p.vectorOne),k.instance.addAutoRecycleScr(e,.5,i.bombEffect),e.active=!0,this.owner.active=!1,$.instance.enemyManager.propDamage(this)}}class Z{constructor(){this.props=[]}init(){R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),R.instance.eventManager.on(t.reset_Game,this,this.resetGame)}stageLoadComplete(){this.curStageConfig=R.instance.userData.getCurStageConfig();let e=this.curStageConfig.propIdInfos;for(let t=0;t<e.length;t++){const i=e[t];this.loadProp(i)}}loadProp(e){let t=$.instance.stageManager.stageRes,i="prop"+e.index,a=t.getChildByName(i);if(!a)return void console.log("表里面的 道具数量 和预制里面 道具数量 不一致   index === "+e.index);let s=R.instance.userData.getPropConfigById(e.id),o=null;switch(s.propType){case l.bomb:(o=new K).init(s,a),this.props.push(o)}}resetGame(){for(let e=0;e<this.props.length;e++){this.props[e].clearData()}this.props=[]}}class $ extends Laya.Script3D{constructor(){super(),this.isGameOver=!1,$._instance=this,this.init()}static get instance(){return $._instance}onAwake(){}onLateUpdate(){this.cameraLogic&&this.cameraLogic.onLateUpdate()}init(){this.bullet=R.instance.scene3D.getChildByName("bullet"),this.cameraLogic=new V,this.cameraLogic.init(),this.heroManager=new _,this.heroManager.init(),this.enemyManager=new Y,this.enemyManager.init(),this.stageManager=new G,this.stageManager.init(),this.missionManager=new Q,this.missionManager.init(),this.propManager=new Z,this.propManager.init(),this.poolManager=new k,this.poolManager.init(),R.instance.eventManager.on(t.startGame,this,this.startGame)}gameOver(e){this.isGameOver||(this.isGameOver=!0,R.instance.eventManager.fire(t.gameOver,e))}startGame(){this.isGameOver=!1}}class ee extends e.BattleViewUI{constructor(){super(),this.aimBtnPos=new Laya.Vector2,this.isCanFire=!1,this.totalBulletCount=4,this.curBulletCount=4,this.isReloadingBullet=!1,this.totalReloadTime=3e3,this.curReloadTime=0,this.isMoveAimDown=!1,this.delayCloseAim=null,this.doCloseAnimCallback=null,this.isStartGame=!1,this.doShowAimBtn=null,this.touchPos=new Laya.Vector2,this.startTouchPos=new Laya.Vector2,this.point=new Laya.Point}onAwake(){}onEnable(){this.init()}onDisable(){R.instance.eventManager.off(t.gameOver,this,this.gameOver)}init(){this.initObj(),this.initMask(),this.aimBox.alpha=0,this.moveAimBg.visible=!1,this.isMoveAimDown=!1,this.aimBtnPos.x=this.aimBtn.x,this.aimBtnPos.y=this.aimBtn.y,this.isCanFire=!1,this.totalBulletCount=4,this.curBulletCount=this.totalBulletCount,this.isReloadingBullet=!1,this.reloadSprite=new Laya.Sprite,this.reloadBox.addChild(this.reloadSprite),this.isStartGame=!1,this.battleInfoBox.visible=!1,this.rightNoticeBg.visible=!1,this.leftNoticeBg.visible=!1,this.hitDirBg.visible=!1,R.instance.timeManager.framLoop(this,this.reloadBullet),this.reloadComplete(),this.hideCancelAimBtn(),this.showMissionList();let e=this;this.delayCloseAim=function(){e.closeAim()},this.doCloseAnimCallback=function(){e.aimBox.alpha=0,e.smallAimBox.visible=!0},this.doShowAimBtn=function(){e.aimBtn.alpha=.7},R.instance.eventManager.on(t.gameOver,this,this.gameOver),R.instance.eventManager.on(t.hero_bloodUpdate,this,this.showDamge),R.instance.eventManager.on(t.missionStateComplete,this,this.missionStateComplete),R.instance.eventManager.on(t.missionUpdateProgress,this,this.missionUpdateProgress)}initObj(){this.aimBtn.on(Laya.Event.MOUSE_DOWN,this,this.onAimBtnDown),this.aimBtn.on(Laya.Event.MOUSE_UP,this,this.onAimBtnUp),this.aimBtn.on(Laya.Event.MOUSE_MOVE,this,this.onAimBtnMove),this.aimBox.on(Laya.Event.MOUSE_DOWN,this,this.onBgBtnDown),this.aimBox.on(Laya.Event.MOUSE_MOVE,this,this.onBgBtnMove),this.aimBox.on(Laya.Event.MOUSE_UP,this,this.onBgBtnUp),this.cancleAimBtn.on(Laya.Event.CLICK,this,this.onCancelBtnClick)}initMask(){var e=new Laya.Sprite;e.alpha=.5,e.graphics.drawRect(0,0,Laya.stage.width,Laya.stage.height,"#000000"),this.maskContain.addChild(e);let t=new Laya.Sprite;t.blendMode="destination-out",this.maskContain.addChild(t);let i=this.maskBox.x,a=this.maskBox.y;t.graphics.drawCircle(i,a,285,"#000000")}startGame(){this.isStartGame=!0,this.missionBox.visible=!1,this.battleInfoBox.visible=!0,this.showBloodInfo(),this.showBattleMissionList(),R.instance.eventManager.fire(t.startGame)}showBloodInfo(){let e=$.instance.heroManager.blood/$.instance.heroManager.bloodBase;this.bloodBar.value=e}showDamge(e){this.showBloodInfo();let t=new Laya.Vector4;R.instance.camera.worldToViewportPoint(e,t);let i=.5*Laya.stage.width,a=.5*Laya.stage.height,s=new Laya.Vector2(t.x-i,t.y-a),o=Laya.MathUtil.getRotation(0,1,s.x,s.y);this.hitDirBg.rotation=o+90,this.hitDirBg.visible=!0,R.instance.timeManager.onceExecute(.2,this,function(){this.hitDirBg.visible=!1})}missionUpdateProgress(e){let t=$.instance.missionManager.allMissionInfos,i=0;for(let a=0;a<t.length;a++){if(t[a].missionCfg.id==e.missionCfg.id){i=a;break}}this.missionIconList.getCell(i).getChildByName("countLabel").text=e.progressNum+"/"+e.missionNum}missionStateComplete(e){let t=$.instance.missionManager.allMissionInfos,i=0;for(let a=0;a<t.length;a++){if(t[a].missionCfg.id==e.missionCfg.id){i=a;break}}let a=this.missionIconList.getCell(i).getChildByName("complete");a.scaleX=2,a.scaleY=2,a.visible=!0,Laya.Tween.to(a,{scaleX:1,scaleY:1},500)}showBattleMissionList(){var e=[];let t=$.instance.missionManager.allMissionInfos;for(let i=0;i<t.length;i++){const a=t[i];let s=!0;1==a.missionNum&&(s=!1),e.push({icon:{skin:"UI/"+a.missionCfg.icon+".png"},countBg:{visible:s},countLabel:{visible:s,text:"0/"+a.missionNum}})}this.missionIconList.array=e,this.missionIconList.repeatX=t.length;let i=130*t.length;this.missionIconList.width=i}showMissionList(){this.missionTitle.text="任 务 "+R.instance.userData.mStageLevel;var e=[];let t=R.instance.userData.getCurStageConfig().missions;for(let i=0;i<t.length;i++){const a=t[i];let s=R.instance.userData.getMissionConfigById(a.id),o=!0;1==a.num&&(o=!1),e.push({icon:{skin:"UI/"+s.icon+".png"},desc:{text:s.desc},countBg:{visible:o},countLabel:{visible:o,text:"x"+a.num}})}this.missionList.repeatY=t.length,this.missionList.array=e;let i=256+138*(t.length-1);this.missionBg.height=i}gameOver(e){e==s.Win?R.instance.timeManager.onceExecute(1.5,this,function(){R.instance.scenesManager.openScene(x.VictoryView,Laya.Handler.create(this,function(e){}))}):R.instance.timeManager.onceExecute(1.5,this,function(){R.instance.scenesManager.openScene(x.FailView,Laya.Handler.create(this,function(t){t.init(e)}))})}showBulletInfo(){var e=[];for(let t=0;t<this.totalBulletCount;t++)t>=this.curBulletCount?e.push({bulletIcon:{alpha:.3}}):e.push({bulletIcon:{alpha:1}});this.bulletList.array=e}startReload(){$.instance.heroManager.reload(),this.isReloadingBullet=!0,this.curReloadTime=0,this.reloadSprite.graphics.clear(),this.reloadBox.visible=!0}reloadComplete(){this.isReloadingBullet=!1,this.curBulletCount=this.totalBulletCount,this.showBulletInfo(),this.reloadBox.visible=!1}reloadBullet(){if(!this.isReloadingBullet)return;this.curReloadTime+=Laya.timer.delta;let e=this.curReloadTime/this.totalReloadTime,t=360*(e=Math.min(1,e));this.reloadSprite.graphics.clear(),this.reloadSprite.graphics.drawPie(this.reloadPos.x,this.reloadPos.y,40,-90,-90+t,"#ffffff"),this.curReloadTime>=this.totalReloadTime&&this.reloadComplete()}showCancelAimBtn(){Laya.Tween.to(this.cancleAimBtn,{x:0},300,null,Laya.Handler.create(this,function(){}))}hideCancelAimBtn(){this.cancleAimBtn.x=-150}closeAim(){R.instance.timeManager.onceExecute(.3,this,this.doCloseAnimCallback),this.hideCancelAimBtn(),R.instance.eventManager.fire(t.ui_closeAim)}openAnim(){R.instance.timeManager.clear(this,this.doCloseAnimCallback),R.instance.timeManager.clear(this,this.doShowAimBtn),this.smallAimBox.visible=!1,this.aimBtn.alpha=0;let e=300*(1-this.aimBox.alpha);Laya.Tween.to(this.aimBox,{alpha:1},e,null,Laya.Handler.create(this,function(){this.isCanFire=!0})),R.instance.eventManager.fire(t.ui_openAim)}onCancelBtnClick(){this.moveAimBg.visible=!0,this.aimBtn.alpha=0,this.isCanFire=!1,this.closeAim()}onBgBtnDown(e){0==this.isStartGame&&this.startGame(),this.moveAimBg.visible=!0,this.aimBtn.visible=!1,this.touchPos.x=e.stageX,this.touchPos.y=e.stageY,this.checkFastMove(e)}onBgBtnMove(e){this.doAimMove(e),this.checkFastMove(e)}onBgBtnUp(e){this.moveAimBg.visible=!1,this.aimBtn.visible=!0,this.checkFastMove(null)}onAimBtnDown(e){0==this.isStartGame&&this.startGame(),this.isMoveAimDown=!1,this.isReloadingBullet?this.onBgBtnDown(e):(this.isMoveAimDown=!0,R.instance.timeManager.clear(this,this.delayCloseAim),this.isCanFire=!1,this.openAnim(),this.showCancelAimBtn(),this.touchPos.x=e.stageX,this.touchPos.y=e.stageY,R.instance.eventManager.fire(t.ui_aimTouchDown))}onAimBtnUp(e){this.checkFastMove(null),this.aimBtn.x=this.aimBtnPos.x,this.aimBtn.y=this.aimBtnPos.y,this.moveAimBg.visible=!1,this.isMoveAimDown?(this.isMoveAimDown=!1,this.curBulletCount>0&&this.isCanFire?($.instance.heroManager.shoot(),R.instance.eventManager.fire(t.ui_shoot),this.curBulletCount--,this.showBulletInfo(),this.curBulletCount<=0&&this.startReload(),R.instance.timeManager.onceExecute(.7,this,this.delayCloseAim),R.instance.timeManager.onceExecute(1,this,this.doShowAimBtn)):(R.instance.timeManager.onceExecute(.3,this,this.doShowAimBtn),this.closeAim()),R.instance.eventManager.fire(t.ui_aimTouchUp),this.isCanFire=!1):this.onBgBtnUp(e)}onAimBtnMove(e){this.doAimMove(e),this.point.x=e.stageX,this.point.y=e.stageY,this.point=this.aimBtn.parent.globalToLocal(this.point),this.aimBtn.x=this.point.x,this.aimBtn.y=this.point.y,this.checkFastMove(e)}doAimMove(e){let t=2*(e.stageX-this.touchPos.x),i=2*(e.stageY-this.touchPos.y);R.instance.timeManager.frameOnce(1,this,function(){$.instance.cameraLogic.moveAim(-t,i)}),this.touchPos.x=e.stageX,this.touchPos.y=e.stageY}checkFastMove(e){let t=o.none;if(null==e)return $.instance.cameraLogic.checkFastMove(t),this.rightNoticeBg.visible=!1,void(this.leftNoticeBg.visible=!1);e.stageX<=100?(t=o.left,this.rightNoticeBg.visible=!1,this.leftNoticeBg.visible=!0):e.stageX>=620?(t=o.right,this.rightNoticeBg.visible=!0,this.leftNoticeBg.visible=!1):(t=o.none,this.rightNoticeBg.visible=!1,this.leftNoticeBg.visible=!1),$.instance.cameraLogic.checkFastMove(t)}}class te extends e.FailViewUI{constructor(){super(),this.isReseting=!1}onAwake(){}onDisable(){R.instance.eventManager.off(t.stage_loadComplete,this,this.stageLoadComplete)}init(e){this.initObj();let i="";switch(e){case s.enemy_escape:i="敌人逃跑了";break;case s.hostage_shooted:i="人质被射杀了";break;case s.shooted:i="你没血了"}this.failDesc.text=i,console.log("游戏失败了  ====== "+i),R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete)}initObj(){this.restartBtn.on(Laya.Event.CLICK,this,this.onRestartBtnClick)}showInfo(){}onRestartBtnClick(){this.isReseting||(this.isReseting=!0,R.instance.eventManager.fire(t.reset_Game))}stageLoadComplete(){console.log("下一关 资源加载完成"),R.instance.scenesManager.openScene(x.BattleView,Laya.Handler.create(this,function(e){R.instance.setSceneUI(e)}))}}class ie extends e.LoadingViewUI{constructor(){super(),this.allLoadCount=0,this.curLoadCount=0,this.isLoading=!1}onAwake(){this.init()}onEnable(){}onDisable(){R.instance.eventManager.off(t.stage_loadComplete,this,this.stageLoadComplete)}init(){R.instance.timeManager.framLoop(this,this.updateProgress),R.instance.userData.loadCache(),this.loadConfig(),this.loadRes(),this.isLoading=!0,R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete)}updateProgress(){if(!this.isLoading)return;let e=0;this.allLoadCount>0&&(e=this.curLoadCount/this.allLoadCount),this.allLoadCount<=this.curLoadCount&&(this.isLoading=!1,this.allLoadComplete())}allLoadComplete(){this.startLoadScene3D()}loadRes(){Laya.Browser.onMiniGame&&this.startLoadSubpackage()}startLoadSubpackage(){this.doLoadSubpackage("unity")}doLoadSubpackage(e){this.allLoadCount+=30;let t=this;wx.loadSubpackage({name:e,success:function(e){t.curLoadCount+=30},fail:function(e){}}).onProgressUpdate(function(e){})}startLoadScene3D(){R.instance.scenesManager.loadScene3D(x.battleScenePath,Laya.Handler.create(this,this.loadScene3DComplete))}loadScene3DComplete(e){R.instance.setScene3D(e),R.instance.scene3D.addComponent($)}stageLoadComplete(){console.log("关卡资源加载完成"),R.instance.scenesManager.openScene(x.BattleView,Laya.Handler.create(this,function(e){R.instance.setSceneUI(e)}))}loadConfig(){this.load("config/StageConfig.json",function(e){R.instance.userData.loadStageConfig(e)}),this.load("config/EnemyConfig.json",function(e){R.instance.userData.loadEnemyConfig(e)}),this.load("config/MissionConfig.json",function(e){R.instance.userData.loadMissionConfig(e)}),this.load("config/PropConfig.json",function(e){R.instance.userData.loadPropConfig(e)})}load(e,t){this.allLoadCount++;let i=this;R.instance.loadManager.load(e,function(e){t(e),i.curLoadCount++})}}class ae extends e.test.TestSceneUI{constructor(){super();var e=Laya.stage.addChild(new Laya.Scene3D),t=e.addChild(new Laya.Camera(0,.1,100));t.transform.translate(new Laya.Vector3(0,3,3)),t.transform.rotate(new Laya.Vector3(-30,0,0),!0,!1);var i=e.addChild(new Laya.DirectionLight);i.color=new Laya.Vector3(.6,.6,.6),i.transform.worldMatrix.setForward(new Laya.Vector3(1,-1,0));var a=e.addChild(new Laya.MeshSprite3D(Laya.PrimitiveMesh.createBox(1,1,1)));a.transform.rotate(new Laya.Vector3(0,45,0),!1,!1);var s=new Laya.BlinnPhongMaterial;Laya.Texture2D.load("res/layabox.png",Laya.Handler.create(null,function(e){s.albedoTexture=e})),a.meshRenderer.material=s}}class se extends e.VictoryViewUI{constructor(){super(),this.isReseting=!1}onAwake(){this.init()}onDisable(){R.instance.eventManager.off(t.stage_loadComplete,this,this.stageLoadComplete)}init(){this.initObj(),this.showInfo(),R.instance.eventManager.on(t.stage_loadComplete,this,this.stageLoadComplete),this.isReseting=!1}initObj(){this.nextBtn.on(Laya.Event.CLICK,this,this.onNextBtnClick)}showInfo(){let e=R.instance.userData.mStageLevel;this.title.text="任 务 "+e,R.instance.userData.nextStage()}onNextBtnClick(){this.isReseting||(this.isReseting=!0,R.instance.eventManager.fire(t.reset_Game))}stageLoadComplete(){console.log("下一关 资源加载完成"),R.instance.scenesManager.openScene(x.BattleView,Laya.Handler.create(this,function(e){R.instance.setSceneUI(e)}))}}class oe{constructor(){}static init(){var e=Laya.ClassUtils.regClass;e("View/BattleView.ts",ee),e("View/FailView.ts",te),e("View/LoadingView.ts",ie),e("script/GameUI.ts",ae),e("View/VictoryView.ts",se)}}oe.width=720,oe.height=1280,oe.scaleMode="fixedwidth",oe.screenMode="none",oe.alignV="top",oe.alignH="left",oe.startScene="LoadingView.scene",oe.sceneRoot="",oe.debug=!1,oe.stat=!1,oe.physicsDebug=!1,oe.exportSceneToJson=!0,oe.init();new class{constructor(){window.Laya3D?Laya3D.init(oe.width,oe.height):Laya.init(oe.width,oe.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=oe.scaleMode,Laya.stage.screenMode=oe.screenMode,Laya.stage.alignV=oe.alignV,Laya.stage.alignH=oe.alignH,Laya.URL.exportSceneToJson=oe.exportSceneToJson,(oe.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),oe.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),oe.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){R.instance.init()}}}();